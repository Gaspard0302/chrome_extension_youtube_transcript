import{M as ee,z as te,a1 as ne,P as G,Q as P,R as U,O as se,V as B,W as oe,S as ae,o as r,f as L,q as f,b as y,Y as ie,U as D,c as le,_ as re,a as h,u as Q,e as ue}from"./types-B0luv8fm.js";function w(e){if(ce(e))return;if(typeof e=="boolean")return{type:"boolean",properties:{}};const{type:t,description:n,required:a,properties:g,items:d,allOf:c,anyOf:l,oneOf:s,format:i,const:m,minLength:v,enum:C}=e,o={};if(n&&(o.description=n),a&&(o.required=a),i&&(o.format=i),m!==void 0&&(o.enum=[m]),t&&(Array.isArray(t)?t.includes("null")?(o.type=t.filter(p=>p!=="null")[0],o.nullable=!0):o.type=t:t==="null"?o.type="null":o.type=t),C!==void 0&&(o.enum=C),g!=null&&(o.properties=Object.entries(g).reduce((p,[u,T])=>(p[u]=w(T),p),{})),d&&(o.items=Array.isArray(d)?d.map(w):w(d)),c&&(o.allOf=c.map(w)),l)if(l.some(p=>typeof p=="object"&&(p==null?void 0:p.type)==="null")){const p=l.filter(u=>!(typeof u=="object"&&(u==null?void 0:u.type)==="null"));if(p.length===1){const u=w(p[0]);typeof u=="object"&&(o.nullable=!0,Object.assign(o,u))}else o.anyOf=p.map(w),o.nullable=!0}else o.anyOf=l.map(w);return s&&(o.oneOf=s.map(w)),v!==void 0&&(o.minLength=v),o}function ce(e){return e!=null&&typeof e=="object"&&e.type==="object"&&(e.properties==null||Object.keys(e.properties).length===0)&&!e.additionalProperties}function de(e){var t,n;const a=[],g=[];let d=!0;for(const{role:c,content:l}of e)switch(c){case"system":{if(!d)throw new D({functionality:"system messages are only supported at the beginning of the conversation"});a.push({text:l});break}case"user":{d=!1;const s=[];for(const i of l)switch(i.type){case"text":{s.push({text:i.text});break}case"image":{s.push(i.image instanceof URL?{fileData:{mimeType:(t=i.mimeType)!=null?t:"image/jpeg",fileUri:i.image.toString()}}:{inlineData:{mimeType:(n=i.mimeType)!=null?n:"image/jpeg",data:le(i.image)}});break}case"file":{s.push(i.data instanceof URL?{fileData:{mimeType:i.mimeType,fileUri:i.data.toString()}}:{inlineData:{mimeType:i.mimeType,data:i.data}});break}}g.push({role:"user",parts:s});break}case"assistant":{d=!1,g.push({role:"model",parts:l.map(s=>{switch(s.type){case"text":return s.text.length===0?void 0:{text:s.text};case"file":{if(s.mimeType!=="image/png")throw new D({functionality:"Only PNG images are supported in assistant messages"});if(s.data instanceof URL)throw new D({functionality:"File data URLs in assistant messages are not supported"});return{inlineData:{mimeType:s.mimeType,data:s.data}}}case"tool-call":return{functionCall:{name:s.toolName,args:s.args}}}}).filter(s=>s!==void 0)});break}case"tool":{d=!1,g.push({role:"user",parts:l.map(s=>({functionResponse:{name:s.toolName,response:{name:s.toolName,content:s.result}}}))});break}}return{systemInstruction:a.length>0?{parts:a}:void 0,contents:g}}function F(e){return e.includes("/")?e:`models/${e}`}var ge=r({error:r({code:f().nullable(),message:h(),status:h()})}),H=re({errorSchema:ge,errorToMessage:e=>e.error.message});function pe(e,t,n,a){var g,d;const c=(g=e.tools)!=null&&g.length?e.tools:void 0,l=[],s=a.includes("gemini-2"),i=a.includes("gemini-1.5-flash")&&!a.includes("-8b");if(t)return{tools:s?{googleSearch:{}}:{googleSearchRetrieval:!i||!n?{}:{dynamicRetrievalConfig:n}},toolConfig:void 0,toolWarnings:l};if(c==null)return{tools:void 0,toolConfig:void 0,toolWarnings:l};const m=[];for(const o of c)o.type==="provider-defined"?l.push({type:"unsupported-tool",tool:o}):m.push({name:o.name,description:(d=o.description)!=null?d:"",parameters:w(o.parameters)});const v=e.toolChoice;if(v==null)return{tools:{functionDeclarations:m},toolConfig:void 0,toolWarnings:l};const C=v.type;switch(C){case"auto":return{tools:{functionDeclarations:m},toolConfig:{functionCallingConfig:{mode:"AUTO"}},toolWarnings:l};case"none":return{tools:{functionDeclarations:m},toolConfig:{functionCallingConfig:{mode:"NONE"}},toolWarnings:l};case"required":return{tools:{functionDeclarations:m},toolConfig:{functionCallingConfig:{mode:"ANY"}},toolWarnings:l};case"tool":return{tools:{functionDeclarations:m},toolConfig:{functionCallingConfig:{mode:"ANY",allowedFunctionNames:[v.toolName]}},toolWarnings:l};default:{const o=C;throw new D({functionality:`Unsupported tool choice type: ${o}`})}}}function $({finishReason:e,hasToolCalls:t}){switch(e){case"STOP":return t?"tool-calls":"stop";case"MAX_TOKENS":return"length";case"IMAGE_SAFETY":case"RECITATION":case"SAFETY":case"BLOCKLIST":case"PROHIBITED_CONTENT":case"SPII":return"content-filter";case"FINISH_REASON_UNSPECIFIED":case"OTHER":return"other";case"MALFORMED_FUNCTION_CALL":return"error";default:return"unknown"}}var he=class{constructor(e,t,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1,this.modelId=e,this.settings=t,this.config=n}get supportsStructuredOutputs(){var e;return(e=this.settings.structuredOutputs)!=null?e:!0}get provider(){return this.config.provider}async getArgs({mode:e,prompt:t,maxTokens:n,temperature:a,topP:g,topK:d,frequencyPenalty:c,presencePenalty:l,stopSequences:s,responseFormat:i,seed:m,providerMetadata:v}){var C,o,p;const u=e.type,T=[],b=se({provider:"google",providerOptions:v,schema:ve});((C=b==null?void 0:b.thinkingConfig)==null?void 0:C.includeThoughts)===!0&&!this.config.provider.startsWith("google.vertex.")&&T.push({type:"other",message:`The 'includeThoughts' option is only supported with the Google Vertex provider and might not be supported or could behave unexpectedly with the current Google provider (${this.config.provider}).`});const I={maxOutputTokens:n,temperature:a,topK:d,topP:g,frequencyPenalty:c,presencePenalty:l,stopSequences:s,seed:m,responseMimeType:(i==null?void 0:i.type)==="json"?"application/json":void 0,responseSchema:(i==null?void 0:i.type)==="json"&&i.schema!=null&&this.supportsStructuredOutputs?w(i.schema):void 0,...this.settings.audioTimestamp&&{audioTimestamp:this.settings.audioTimestamp},responseModalities:b==null?void 0:b.responseModalities,thinkingConfig:b==null?void 0:b.thinkingConfig},{contents:R,systemInstruction:N}=de(t);switch(u){case"regular":{const{tools:k,toolConfig:E,toolWarnings:M}=pe(e,(o=this.settings.useSearchGrounding)!=null?o:!1,this.settings.dynamicRetrievalConfig,this.modelId);return{args:{generationConfig:I,contents:R,systemInstruction:N,safetySettings:this.settings.safetySettings,tools:k,toolConfig:E,cachedContent:this.settings.cachedContent},warnings:[...T,...M]}}case"object-json":return{args:{generationConfig:{...I,responseMimeType:"application/json",responseSchema:e.schema!=null&&this.supportsStructuredOutputs?w(e.schema):void 0},contents:R,systemInstruction:N,safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:T};case"object-tool":return{args:{generationConfig:I,contents:R,systemInstruction:N,tools:{functionDeclarations:[{name:e.tool.name,description:(p=e.tool.description)!=null?p:"",parameters:w(e.tool.parameters)}]},toolConfig:{functionCallingConfig:{mode:"ANY"}},safetySettings:this.settings.safetySettings,cachedContent:this.settings.cachedContent},warnings:T};default:{const k=u;throw new Error(`Unsupported type: ${k}`)}}}supportsUrl(e){return this.config.isSupportedUrl(e)}async doGenerate(e){var t,n,a,g,d;const{args:c,warnings:l}=await this.getArgs(e),s=JSON.stringify(c),i=G(await P(this.config.headers),e.headers),{responseHeaders:m,value:v,rawValue:C}=await U({url:`${this.config.baseURL}/${F(this.modelId)}:generateContent`,headers:i,body:c,failedResponseHandler:H,successfulResponseHandler:B(me),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:o,...p}=c,u=v.candidates[0],T=u.content==null||typeof u.content!="object"||!("parts"in u.content)?[]:u.content.parts,b=V({parts:T,generateId:this.config.generateId}),I=v.usageMetadata;return{text:J(T),reasoning:Y(T),files:(t=K(T))==null?void 0:t.map(R=>({data:R.inlineData.data,mimeType:R.inlineData.mimeType})),toolCalls:b,finishReason:$({finishReason:u.finishReason,hasToolCalls:b!=null&&b.length>0}),usage:{promptTokens:(n=I==null?void 0:I.promptTokenCount)!=null?n:NaN,completionTokens:(a=I==null?void 0:I.candidatesTokenCount)!=null?a:NaN},rawCall:{rawPrompt:o,rawSettings:p},rawResponse:{headers:m,body:C},warnings:l,providerMetadata:{google:{groundingMetadata:(g=u.groundingMetadata)!=null?g:null,safetyRatings:(d=u.safetyRatings)!=null?d:null}},sources:W({groundingMetadata:u.groundingMetadata,generateId:this.config.generateId}),request:{body:s}}}async doStream(e){const{args:t,warnings:n}=await this.getArgs(e),a=JSON.stringify(t),g=G(await P(this.config.headers),e.headers),{responseHeaders:d,value:c}=await U({url:`${this.config.baseURL}/${F(this.modelId)}:streamGenerateContent?alt=sse`,headers:g,body:t,failedResponseHandler:H,successfulResponseHandler:oe(ye),abortSignal:e.abortSignal,fetch:this.config.fetch}),{contents:l,...s}=t;let i="unknown",m={promptTokens:Number.NaN,completionTokens:Number.NaN},v;const C=this.config.generateId;let o=!1;return{stream:c.pipeThrough(new TransformStream({transform(p,u){var T,b,I,R,N,k;if(!p.success){u.enqueue({type:"error",error:p.error});return}const E=p.value,M=E.usageMetadata;M!=null&&(m={promptTokens:(T=M.promptTokenCount)!=null?T:NaN,completionTokens:(b=M.candidatesTokenCount)!=null?b:NaN});const x=(I=E.candidates)==null?void 0:I[0];if(x==null)return;const O=x.content;if(O!=null){const A=J(O.parts);A!=null&&u.enqueue({type:"text-delta",textDelta:A});const _=Y(O.parts);if(_!=null)for(const S of _)u.enqueue({type:"reasoning",textDelta:S.text});const j=K(O.parts);if(j!=null)for(const S of j)u.enqueue({type:"file",mimeType:S.inlineData.mimeType,data:S.inlineData.data});const q=V({parts:O.parts,generateId:C});if(q!=null)for(const S of q)u.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:S.toolCallId,toolName:S.toolName,argsTextDelta:S.args}),u.enqueue({type:"tool-call",toolCallType:"function",toolCallId:S.toolCallId,toolName:S.toolName,args:S.args}),o=!0}if(x.finishReason!=null){i=$({finishReason:x.finishReason,hasToolCalls:o});const A=(R=W({groundingMetadata:x.groundingMetadata,generateId:C}))!=null?R:[];for(const _ of A)u.enqueue({type:"source",source:_});v={google:{groundingMetadata:(N=x.groundingMetadata)!=null?N:null,safetyRatings:(k=x.safetyRatings)!=null?k:null}}}},flush(p){p.enqueue({type:"finish",finishReason:i,usage:m,providerMetadata:v})}})),rawCall:{rawPrompt:l,rawSettings:s},rawResponse:{headers:d},warnings:n,request:{body:a}}}};function V({parts:e,generateId:t}){const n=e==null?void 0:e.filter(a=>"functionCall"in a);return n==null||n.length===0?void 0:n.map(a=>({toolCallType:"function",toolCallId:t(),toolName:a.functionCall.name,args:JSON.stringify(a.functionCall.args)}))}function J(e){const t=e==null?void 0:e.filter(n=>"text"in n&&n.thought!==!0);return t==null||t.length===0?void 0:t.map(n=>n.text).join("")}function Y(e){const t=e==null?void 0:e.filter(n=>"text"in n&&n.thought===!0&&n.text!=null);return t==null||t.length===0?void 0:t.map(n=>({type:"text",text:n.text}))}function K(e){return e==null?void 0:e.filter(t=>"inlineData"in t)}function W({groundingMetadata:e,generateId:t}){var n;return(n=e==null?void 0:e.groundingChunks)==null?void 0:n.filter(a=>a.web!=null).map(a=>({sourceType:"url",id:t(),url:a.web.uri,title:a.web.title}))}var X=r({parts:y(Q([r({functionCall:r({name:h(),args:ue()})}),r({inlineData:r({mimeType:h(),data:h()})}),r({text:h().nullish(),thought:L().nullish()})])).nullish()}),fe=r({web:r({uri:h(),title:h()}).nullish(),retrievedContext:r({uri:h(),title:h()}).nullish()}),z=r({webSearchQueries:y(h()).nullish(),retrievalQueries:y(h()).nullish(),searchEntryPoint:r({renderedContent:h()}).nullish(),groundingChunks:y(fe).nullish(),groundingSupports:y(r({segment:r({startIndex:f().nullish(),endIndex:f().nullish(),text:h().nullish()}),segment_text:h().nullish(),groundingChunkIndices:y(f()).nullish(),supportChunkIndices:y(f()).nullish(),confidenceScores:y(f()).nullish(),confidenceScore:y(f()).nullish()})).nullish(),retrievalMetadata:Q([r({webDynamicRetrievalScore:f()}),r({})]).nullish()}),Z=r({category:h().nullish(),probability:h().nullish(),probabilityScore:f().nullish(),severity:h().nullish(),severityScore:f().nullish(),blocked:L().nullish()}),me=r({candidates:y(r({content:X.nullish().or(r({}).strict()),finishReason:h().nullish(),safetyRatings:y(Z).nullish(),groundingMetadata:z.nullish()})),usageMetadata:r({promptTokenCount:f().nullish(),candidatesTokenCount:f().nullish(),totalTokenCount:f().nullish()}).nullish()}),ye=r({candidates:y(r({content:X.nullish(),finishReason:h().nullish(),safetyRatings:y(Z).nullish(),groundingMetadata:z.nullish()})).nullish(),usageMetadata:r({promptTokenCount:f().nullish(),candidatesTokenCount:f().nullish(),totalTokenCount:f().nullish()}).nullish()}),ve=r({responseModalities:y(ie(["TEXT","IMAGE"])).nullish(),thinkingConfig:r({thinkingBudget:f().nullish(),includeThoughts:L().nullish()}).nullish()}),Te=class{constructor(e,t,n){this.specificationVersion="v1",this.modelId=e,this.settings=t,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){return 2048}get supportsParallelCalls(){return!0}async doEmbed({values:e,headers:t,abortSignal:n}){if(e.length>this.maxEmbeddingsPerCall)throw new ne({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const a=G(await P(this.config.headers),t),{responseHeaders:g,value:d}=await U({url:`${this.config.baseURL}/models/${this.modelId}:batchEmbedContents`,headers:a,body:{requests:e.map(c=>({model:`models/${this.modelId}`,content:{role:"user",parts:[{text:c}]},outputDimensionality:this.settings.outputDimensionality,taskType:this.settings.taskType}))},failedResponseHandler:H,successfulResponseHandler:B(Ce),abortSignal:n,fetch:this.config.fetch});return{embeddings:d.embeddings.map(c=>c.values),usage:void 0,rawResponse:{headers:g}}}},Ce=r({embeddings:y(r({values:y(f())}))});function be(e){return e.toString().startsWith("https://generativelanguage.googleapis.com/v1beta/files/")}function we(e={}){var t;const n=(t=ee(e.baseURL))!=null?t:"https://generativelanguage.googleapis.com/v1beta",a=()=>({"x-goog-api-key":ae({apiKey:e.apiKey,environmentVariableName:"GOOGLE_GENERATIVE_AI_API_KEY",description:"Google Generative AI"}),...e.headers}),g=(l,s={})=>{var i;return new he(l,s,{provider:"google.generative-ai",baseURL:n,headers:a,generateId:(i=e.generateId)!=null?i:te,isSupportedUrl:be,fetch:e.fetch})},d=(l,s={})=>new Te(l,s,{provider:"google.generative-ai",baseURL:n,headers:a,fetch:e.fetch}),c=function(l,s){if(new.target)throw new Error("The Google Generative AI model function cannot be called with the new keyword.");return g(l,s)};return c.languageModel=g,c.chat=g,c.generativeAI=g,c.embedding=d,c.textEmbedding=d,c.textEmbeddingModel=d,c}var Se=we();export{we as createGoogleGenerativeAI,Se as google};
