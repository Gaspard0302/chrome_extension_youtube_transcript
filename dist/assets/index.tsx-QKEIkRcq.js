import{r as h,j as t,a as _,c as ne}from"./client-B2dwjR_T.js";import{P as J,D as K}from"./providers-DGP2A9J8.js";function ae(a){var r;const e=a.split('"captions":');if(e.length<=1)return[];try{const o=e[1].split(',"videoDetails')[0].replace(/\n/g,""),n=JSON.parse(o),s=(r=n==null?void 0:n.playerCaptionsTracklistRenderer)==null?void 0:r.captionTracks;if(Array.isArray(s)&&s.length>0)return s}catch{}return[]}function oe(){var e,r;const a=document.querySelector('script[id="ytInitialPlayerResponse"]');if(a!=null&&a.textContent)try{const o=JSON.parse(a.textContent),n=(r=(e=o==null?void 0:o.captions)==null?void 0:e.playerCaptionsTracklistRenderer)==null?void 0:r.captionTracks;if(Array.isArray(n)&&n.length>0)return n}catch{}for(const o of document.querySelectorAll("script")){const n=o.textContent??"";if(n.includes('"captionTracks"')){const s=ae(n);if(s.length>0)return s}}throw new Error("No captions found. This video may not have a transcript.")}async function se(a){var n,s;const e=await fetch("https://www.youtube.com/youtubei/v1/player?prettyPrint=false",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"ANDROID",clientVersion:"20.10.38"}},videoId:a})});if(!e.ok)throw new Error(`Innertube player returned ${e.status}`);const r=await e.json(),o=(s=(n=r==null?void 0:r.captions)==null?void 0:n.playerCaptionsTracklistRenderer)==null?void 0:s.captionTracks;return Array.isArray(o)?o:[]}async function ie(a){var i,p,f,b,T,S,C,k,R,j;const e={steps:[]};let r=[],o=null;try{r=await se(a),e.steps.push({label:"Page fetch caption tracks",status:r.length>0?"ok":"warn",detail:r.length>0?`Found ${r.length} track(s): ${r.map(d=>`${d.languageCode}${d.kind?` [${d.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(d){o=d instanceof Error?d.message:String(d),e.steps.push({label:"Page fetch caption tracks",status:"error",detail:o})}if(r.length===0)try{r=oe(),e.steps.push({label:"DOM fallback caption tracks",status:r.length>0?"ok":"warn",detail:r.length>0?`Found ${r.length} track(s): ${r.map(d=>`${d.languageCode}${d.kind?` [${d.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(d){const E=d instanceof Error?d.message:String(d);throw e.steps.push({label:"DOM fallback caption tracks",status:"error",detail:E}),Object.assign(new Error(`Could not find any caption tracks.
Background: ${o??"n/a"}
DOM: ${E}`),{diagnostics:e})}if(r.length===0)throw e.steps.push({label:"Select track",status:"error",detail:"No tracks available to select."}),Object.assign(new Error("No caption tracks found in background fetch or DOM."),{diagnostics:e});const n=r.find(d=>d.languageCode==="en"&&!d.kind)??r.find(d=>d.languageCode==="en")??r[0];e.steps.push({label:"Select track",status:"ok",detail:`Using "${((i=n.name)==null?void 0:i.simpleText)??"unknown"}" (lang=${n.languageCode}, kind=${n.kind??"manual"})`});try{const d=new TextEncoder,E=d.encode(a),l=d.encode(n.languageCode),g=btoa(String.fromCharCode(10,E.length,...E,18,l.length,...l)),v=await fetch("https://www.youtube.com/youtubei/v1/get_transcript?prettyPrint=false",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"WEB",clientVersion:"2.20241126.01.00",hl:"en",gl:"US"}},params:g})});if(v.ok){const w=await v.json(),M=((k=(C=(S=(T=(b=(f=(p=w==null?void 0:w.actions)==null?void 0:p[0])==null?void 0:f.updateEngagementPanelAction)==null?void 0:b.content)==null?void 0:T.transcriptRenderer)==null?void 0:S.body)==null?void 0:C.transcriptBodyRenderer)==null?void 0:k.cueGroups)??[],D=[];for(const B of M)for(const O of((R=B==null?void 0:B.transcriptCueGroupRenderer)==null?void 0:R.cues)??[]){const c=O==null?void 0:O.transcriptCueRenderer,m=(((j=c==null?void 0:c.cue)==null?void 0:j.simpleText)??"").trim(),$=parseInt((c==null?void 0:c.startOffsetMs)??"0",10)/1e3,y=parseInt((c==null?void 0:c.durationMs)??"0",10)/1e3;m&&D.push({text:m,start:$,duration:y})}if(D.length>0)return e.steps.push({label:"get_transcript API",status:"ok",detail:`${D.length} cues via Innertube get_transcript`}),{segments:D,tracksLen:r.length,diagnostics:e}}e.steps.push({label:"get_transcript API",status:"warn",detail:`status=${v.status}, no cues — falling back to timedtext`})}catch(d){e.steps.push({label:"get_transcript API",status:"warn",detail:`Error: ${d instanceof Error?d.message:String(d)} — falling back to timedtext`})}let s;try{s=await ce(n.baseUrl,e)}catch(d){const E=d instanceof Error?d.message:String(d);throw Object.assign(new Error(E),{diagnostics:e})}return{segments:s,tracksLen:r.length,diagnostics:e}}async function ce(a,e){const r=(()=>{try{const s=new URL(a);return s.searchParams.delete("exp"),s.toString()}catch{return a}})();a!==r&&e.steps.push({label:"Stripped exp param",status:"ok",detail:"Removed exp=xpe from timedtext URL to disable POT enforcement."});let o="skipped";try{const s=r+"&fmt=json3",i=await fetch(s,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),p=i.headers.get("content-length")??"unknown",f=await i.text();if(e.steps.push({label:"HTTP response (JSON3)",status:f.length>0?"ok":"error",detail:`status=${i.status}, content-length=${p}, body=${f.length} bytes, preview: ${JSON.stringify(f.slice(0,200))}`}),o=`${f.length} bytes`,f){const b=JSON.parse(f),T=[];for(const S of b.events??[]){if(!S.segs)continue;const C=S.segs.map(k=>k.utf8).join("").replace(/\n/g," ").trim();C&&T.push({text:C,start:S.tStartMs/1e3,duration:S.dDurationMs/1e3})}if(T.length>0)return e.steps.push({label:"Fetch JSON3 transcript",status:"ok",detail:`${T.length} events, ${o}`}),T;o+=" (0 events after filtering)"}else o="empty body"}catch(s){o=`Error: ${s instanceof Error?s.message:String(s)}`}e.steps.push({label:"Fetch JSON3 transcript",status:"warn",detail:o+" — falling back to XML"});let n="skipped";try{const s=await fetch(r,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),i=s.headers.get("content-length")??"unknown",p=await s.text();e.steps.push({label:"HTTP response (XML)",status:p.length>0?"ok":"error",detail:`status=${s.status}, content-length=${i}, body=${p.length} bytes, preview: ${JSON.stringify(p.slice(0,200))}`}),n=`${p.length} bytes`;const f=le(p);return e.steps.push({label:"Fetch XML transcript",status:"ok",detail:`${f.length} segments, ${n}`}),f}catch(s){const i=s instanceof Error?s.message:String(s);throw e.steps.push({label:"Fetch XML transcript",status:"error",detail:`${n} — ${i}`}),new Error(i)}}function V(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/\n/g," ").trim()}function le(a){const e=new DOMParser().parseFromString(a,"text/xml"),r=[],o=e.querySelectorAll("p");if(o.length>0){for(const n of o){const s=parseFloat(n.getAttribute("t")??"0"),i=parseFloat(n.getAttribute("d")??"0"),p=n.querySelectorAll("s"),f=p.length>0?Array.from(p).map(T=>T.textContent??"").join(""):n.textContent??"",b=V(f);b&&r.push({text:b,start:s/1e3,duration:i/1e3})}if(r.length>0)return r}for(const n of e.querySelectorAll("text")){const s=parseFloat(n.getAttribute("start")??"0"),i=parseFloat(n.getAttribute("dur")??"0"),p=V(n.textContent??"");p&&r.push({text:p,start:s,duration:i})}if(r.length===0)throw new Error(`XML parsed but yielded 0 segments. XML snippet: ${a.slice(0,300)}`);return r}function de(a,e=80){const r=[];let o="",n=0,s=0;for(const i of a)o.split(/\s+/).filter(Boolean).length>=e&&o.length>0?(r.push({text:o.trim(),start:n,duration:s}),o=i.text,n=i.start,s=i.duration):(o||(n=i.start,s=0),o+=(o?" ":"")+i.text,s=i.start+i.duration-n);return o.trim()&&r.push({text:o.trim(),start:n,duration:s}),r}function ee(a){const e=Math.floor(a/3600),r=Math.floor(a%3600/60),o=Math.floor(a%60);return e>0?`${e}:${String(r).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${r}:${String(o).padStart(2,"0")}`}function pe(a){const e=a.match(/[?&]v=([^&]+)/);return e?e[1]:null}async function te(a){return new Promise((e,r)=>{chrome.runtime.sendMessage({type:"EMBED_TEXT",payload:{text:a}},o=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):!o||o.error?r(new Error((o==null?void 0:o.error)??"No response from background")):e(o.embedding)})})}async function ue(a,e){const r=[];for(let o=0;o<a.length;o++){const n=a[o],s=await te(n.text);r.push({...n,embedding:s,index:o}),e==null||e(Math.round((o+1)/a.length*100))}return r}function fe(a,e){if(a.length!==e.length||a.length===0)return 0;let r=0,o=0,n=0;for(let i=0;i<a.length;i++)r+=a[i]*e[i],o+=a[i]*a[i],n+=e[i]*e[i];const s=Math.sqrt(o)*Math.sqrt(n);return s===0?0:Math.max(-1,Math.min(1,r/s))}function he(a,e,r=5){const o=e.map(n=>({segment:n,score:fe(a,n.embedding)}));return o.sort((n,s)=>s.score-n.score),o.slice(0,r)}function ge({segments:a,settings:e,onSettingsChange:r}){const[o,n]=h.useState([]),[s,i]=h.useState(""),[p,f]=h.useState(!1),[b,T]=h.useState(""),S=h.useRef(null),C=h.useRef(""),k=J.filter(c=>!c.requiresKey||(e.apiKeys[c.id]??"").length>0),R=k.length>0,j=k.find(c=>c.id===e.selectedProvider)??k[0]??null,d=J.find(c=>c.id===e.selectedProvider),E=e.apiKeys[e.selectedProvider]??"",l=!(d!=null&&d.requiresKey)||E.length>0,g=!!e.selectedModel;h.useEffect(()=>{if(!e.selectedModel&&k.length>0){const c=k[0];r({...e,selectedProvider:c.id,selectedModel:c.models[0].id})}},[k.length,e.selectedModel]),h.useEffect(()=>{const c=S.current;c&&(c.scrollTop=c.scrollHeight)},[o,p]);function v(){return`You are a helpful assistant answering questions about a YouTube video. You have full access to the transcript below — use it as the single source of truth.

When you reference anything from the video (a quote, a claim, an explanation), you MUST cite the exact timestamp so the user can click it and jump the video to that moment. Use this format only: [MM:SS] for times under an hour (e.g. [5:42]) or [H:MM:SS] for longer (e.g. [1:23:45]). The user's player will make these clickable.

FULL TRANSCRIPT (each line is [timestamp] text):
${a.map(m=>`[${ee(m.start)}] ${m.text}`).join(`
`)}

Rules:
- Answer only from the transcript content above.
- For every specific reference to the video, include a timestamp in [MM:SS] or [H:MM:SS] so the user can click to seek.
- If the video doesn't cover the topic, say so clearly.
- Be concise and direct.`}async function w(){if(!s.trim()||p)return;const c={role:"user",content:s.trim()},m=[...o,c];n(m),i(""),f(!0),T(""),C.current="",n(y=>[...y,{role:"assistant",content:""}]);const $=y=>{y.type==="CHAT_CHUNK"&&(C.current=y.payload.fullText,n(u=>{const x=[...u];return x[x.length-1]={role:"assistant",content:C.current},x}))};chrome.runtime.onMessage.addListener($);try{const y=await chrome.runtime.sendMessage({type:"CHAT_STREAM",payload:{messages:m.map(u=>({role:u.role,content:u.content})),systemPrompt:v(),provider:e.selectedProvider,model:e.selectedModel,apiKey:E,ollamaBaseUrl:e.ollamaBaseUrl}});y!=null&&y.error&&(T(y.error),n(u=>u.slice(0,-1)))}catch(y){T(y instanceof Error?y.message:"Unknown error"),n(u=>u.slice(0,-1))}finally{chrome.runtime.onMessage.removeListener($),f(!1)}}function M(c){c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),w())}function D(c){const m=document.querySelector("video");m&&(m.currentTime=c,m.play())}function B(c){const m=c.match(/^\[(\d+):(\d{2})(?::(\d{2}))?\]$/),$=c.match(/^\((\d+):(\d{2})(?::(\d{2}))?\)$/),y=m??$;if(!y)return null;const u=y[3]!==void 0?parseInt(y[1],10):0,x=y[3]!==void 0?parseInt(y[2],10):parseInt(y[1],10),A=y[3]!==void 0?parseInt(y[3],10):parseInt(y[2],10);return u*3600+x*60+A}function O(c){const m=/(\[\d+:\d{2}(?::\d{2})?\]|\(\d+:\d{2}(?::\d{2})?\))/g;return c.split(m).map((y,u)=>{const x=B(y);return x!==null?t.jsx("button",{type:"button",onClick:()=>D(x),style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:4,color:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",cursor:"pointer",fontSize:12,fontWeight:700,padding:"1px 6px",margin:"0 2px",fontFamily:"inherit"},children:y},u):t.jsx("span",{children:y},u)})}return t.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[t.jsx("div",{style:{padding:"8px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",gap:6,alignItems:"center",flexShrink:0},children:R?t.jsxs(t.Fragment,{children:[t.jsx("select",{value:(j==null?void 0:j.id)??"",onChange:c=>{const m=k.find($=>$.id===c.target.value);r({...e,selectedProvider:m.id,selectedModel:m.models[0].id})},style:X,children:k.map(c=>t.jsx("option",{value:c.id,children:c.label},c.id))}),t.jsx("select",{value:e.selectedModel,onChange:c=>r({...e,selectedModel:c.target.value}),style:X,children:((j==null?void 0:j.models)??[]).map(c=>t.jsx("option",{value:c.id,children:c.label},c.id))})]}):t.jsx("span",{style:{fontSize:12,color:"#fbbf24"},children:"No API provider configured. Add an API key in the extension settings."})}),!l&&t.jsxs("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(42,26,0,0.8)",border:"1px solid rgba(124,74,0,0.8)",borderRadius:6,fontSize:12,color:"#fbbf24",flexShrink:0},children:["No API key set for ",d==null?void 0:d.label,". Add one in the extension settings."]}),l&&!g&&t.jsx("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",borderRadius:6,fontSize:12,color:"var(--yt-spec-text-secondary, #aaa)",flexShrink:0},children:"Select a model in the extension settings to use AI Chat."}),t.jsxs("div",{ref:S,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"12px",display:"flex",flexDirection:"column",gap:10},children:[o.length===0&&t.jsxs("div",{style:{textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13,marginTop:16,lineHeight:1.7},children:["Ask anything about this video.",t.jsx("br",{}),t.jsx("span",{style:{fontSize:11},children:"Timestamps in answers are clickable."})]}),o.map((c,m)=>t.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:c.role==="user"?"flex-end":"flex-start"},children:t.jsxs("div",{style:{maxWidth:"88%",padding:"9px 12px",borderRadius:c.role==="user"?"12px 12px 2px 12px":"12px 12px 12px 2px",background:c.role==="user"?"var(--yt-spec-call-to-action-inverse-color, #cc0000)":"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",fontSize:13,lineHeight:1.6,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:[c.role==="assistant"?O(c.content):c.content,p&&m===o.length-1&&c.role==="assistant"&&!c.content&&t.jsx("span",{style:{color:"var(--yt-spec-text-secondary, #aaa)"},children:"▋"})]})},m)),b&&t.jsxs("div",{style:{color:"#f87171",fontSize:12,padding:"4px 0"},children:["Error: ",b]})]}),t.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0,background:"var(--yt-spec-brand-background-solid, #212121)"},children:[t.jsx("textarea",{value:s,onChange:c=>i(c.target.value),onKeyDown:M,placeholder:"Ask about the video… (Enter to send)",disabled:p||!l||!g||!R,rows:1,style:{flex:1,background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:20,padding:"9px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:100,overflow:"auto",boxSizing:"border-box"},onFocus:c=>c.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:c=>c.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))"}),t.jsx("button",{onClick:w,disabled:p||!s.trim()||!l||!g||!R,style:{background:p||!s.trim()||!l||!g||!R?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))":"var(--yt-spec-call-to-action-inverse-color, #ff0000)",border:"none",borderRadius:"50%",color:"var(--yt-spec-static-brand-white, #fff)",cursor:p||!s.trim()||!l||!g||!R?"default":"pointer",width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:700,transition:"background 0.15s",flexShrink:0,fontFamily:"inherit"},children:p?"…":"↑"})]})]})}const X={background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:16,color:"var(--yt-spec-text-primary, #f1f1f1)",padding:"5px 10px",fontSize:12,cursor:"pointer",flex:1,outline:"none",fontFamily:"'Roboto', 'Arial', sans-serif"};function q(a,e){if(!a.trim())return[];const r=a.toLowerCase().trim(),o=[];for(let n=0;n<e.length;n++){const s=e[n];s.text.toLowerCase().includes(r)&&o.push({segment:s,index:n,score:1,matchType:"exact"})}return o}async function ye(a,e,r=8){if(!a.trim())return[];const o=q(a,e),n=new Set(o.map(f=>f.index)),s=await te(a),i=he(s,e,r),p=[...o];for(const{segment:f,score:b}of i)!n.has(f.index)&&b>.3&&p.push({segment:f,index:f.index,score:b,matchType:"semantic"});return p.sort((f,b)=>f.matchType==="exact"&&b.matchType!=="exact"?-1:b.matchType==="exact"&&f.matchType!=="exact"?1:b.score-f.score),p}function Y(a,e){if(!e.trim())return a;const r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return a.replace(new RegExp(`(${r})`,"gi"),"<mark>$1</mark>")}function me({segments:a,semanticEnabled:e}){const[r,o]=h.useState(null),[n,s]=h.useState(""),[i,p]=h.useState(null),[f,b]=h.useState(!1),T=h.useRef(null),S=h.useRef(null);h.useEffect(()=>{const l=document.querySelector("video");if(!l)return;function g(){const v=l.currentTime;let w=0;for(let M=0;M<a.length&&a[M].start<=v;M++)w=M;o(w)}return l.addEventListener("timeupdate",g),()=>l.removeEventListener("timeupdate",g)},[a]),h.useEffect(()=>{var g;if(r===null||i!==null)return;const l=(g=T.current)==null?void 0:g.querySelector(`[data-index="${r}"]`);l==null||l.scrollIntoView({block:"nearest",behavior:"smooth"})},[r,i]);function C(l){const g=document.querySelector("video");g&&(g.currentTime=l,g.play())}const k=h.useCallback(async l=>{if(!l.trim()){p(null);return}b(!0);try{const g=e?await ye(l,a):q(l,a).map(v=>({...v}));p(g.map(v=>({segment:v.segment,highlighted:Y(v.segment.text,l),matchType:v.matchType})))}catch{const g=q(l,a).map(v=>({segment:v.segment,highlighted:Y(v.segment.text,l),matchType:v.matchType}));p(g)}finally{b(!1)}},[a,e]);function R(l){const g=l.target.value;if(s(g),S.current&&clearTimeout(S.current),!g.trim()){p(null);return}S.current=setTimeout(()=>k(g),300)}function j(){S.current&&(clearTimeout(S.current),S.current=null);const l=n.trim();if(!l){p(null);return}k(l)}function d(l){l.key==="Enter"&&(l.preventDefault(),j())}const E=i!==null?i:a.map(l=>({segment:l,highlighted:"",matchType:""}));return t.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[t.jsxs("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",flexShrink:0},children:[t.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[t.jsxs("div",{style:{position:"relative",flex:1},children:[t.jsx("input",{type:"text",value:n,onChange:R,onKeyDown:d,placeholder:e?"Filter by meaning or keyword…":"Filter transcript…",style:{width:"100%",background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:"20px",padding:"8px 32px 8px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,outline:"none",fontFamily:"inherit",boxSizing:"border-box"},onFocus:l=>l.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:l=>l.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"}),f?t.jsx("div",{style:{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",width:14,height:14,border:"2px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.2))",borderTopColor:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",borderRadius:"50%",animation:"yt-transcript-spin 0.6s linear infinite"}}):n?t.jsx("button",{onClick:()=>{s(""),p(null)},style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:16,lineHeight:1,padding:0,fontFamily:"inherit"},title:"Clear search",children:"×"}):null]}),t.jsx("button",{type:"button",onClick:j,disabled:f||!n.trim(),style:{flexShrink:0,padding:"8px 14px",borderRadius:"18px",border:"none",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",color:"var(--yt-spec-static-brand-white, #fff)",fontSize:13,fontWeight:600,cursor:f||!n.trim()?"default":"pointer",fontFamily:"inherit",opacity:f||!n.trim()?.6:1},children:"Search"})]}),n&&i!==null&&t.jsxs("p",{style:{margin:"4px 0 0",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i.length===0?"No results":`${i.length} result${i.length===1?"":"s"}`,e&&" · AI semantic search active"]})]}),t.jsxs("div",{ref:T,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"4px 0"},children:[E.length===0&&n&&t.jsxs("div",{style:{padding:"16px 12px",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:["No results for “",n,"”"]}),E.map(({segment:l,highlighted:g,matchType:v})=>{const w=!n&&r===l.index;return t.jsxs("div",{"data-index":l.index,onClick:()=>C(l.start),style:{padding:"8px 12px",cursor:"pointer",background:w?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))":"transparent",borderLeft:w?"3px solid var(--yt-spec-call-to-action-inverse-color, #ff0000)":"3px solid transparent",transition:"background 0.15s"},onMouseEnter:M=>{w||(M.currentTarget.style.background="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))")},onMouseLeave:M=>{w||(M.currentTarget.style.background="transparent")},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:2},children:[t.jsx("span",{style:{fontSize:11,fontWeight:700,color:w?"var(--yt-spec-call-to-action-inverse-color, #ff0000)":"var(--yt-spec-text-secondary, #aaa)",fontVariantNumeric:"tabular-nums"},children:ee(l.start)}),v==="semantic"&&t.jsx("span",{style:{fontSize:10,background:"rgba(59,130,246,0.15)",color:"#60a5fa",borderRadius:3,padding:"1px 5px",fontWeight:600},children:"AI"})]}),g?t.jsx("p",{style:{margin:0,fontSize:13,color:"var(--yt-spec-text-primary, #f1f1f1)",lineHeight:1.5},dangerouslySetInnerHTML:{__html:g}}):t.jsx("p",{style:{margin:0,fontSize:13,color:w?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-text-secondary, #aaa)",lineHeight:1.5},children:l.text})]},l.index)})]})]})}const G={ok:"#4ade80",warn:"#facc15",error:"#f87171"},xe={ok:"✓",warn:"⚠",error:"✗"};function Q({segments:a,errorDetails:e,diagnostics:r}){const o=a.reduce((s,i)=>s+i.text.split(" ").length,0),n=a.length>0?a[a.length-1].start+a[a.length-1].duration:0;return t.jsxs("div",{style:{padding:16,fontSize:13,color:"var(--yt-spec-text-secondary, #aaa)",overflowY:"auto",flex:1,minHeight:0},children:[t.jsx("h3",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:12,fontSize:14,fontWeight:600},children:"Debug Details"}),r&&r.steps.length>0&&t.jsxs("div",{style:{marginBottom:20},children:[t.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Pipeline Steps"}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:r.steps.map((s,i)=>t.jsxs("div",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",borderRadius:6,padding:"8px 10px",borderLeft:`3px solid ${G[s.status]??"var(--yt-spec-text-secondary, #555)"}`},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:s.detail?4:0},children:[t.jsx("span",{style:{color:G[s.status]??"var(--yt-spec-text-secondary, #555)",fontWeight:700,fontSize:12,minWidth:14},children:xe[s.status]??"?"}),t.jsx("span",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",fontWeight:500},children:s.label})]}),s.detail&&t.jsx("div",{style:{marginLeft:20,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:11,wordBreak:"break-all"},children:s.detail})]},i))})]}),e&&t.jsxs("div",{style:{marginBottom:20,padding:12,background:"rgba(248,113,113,0.08)",border:"1px solid #f87171",color:"#f87171",borderRadius:6},children:[t.jsx("strong",{style:{display:"block",marginBottom:6,fontSize:11,textTransform:"uppercase",letterSpacing:"0.05em"},children:"Full Error Trace"}),t.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",fontSize:11,wordBreak:"break-all",fontFamily:"monospace"},children:e})]}),t.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Transcript Stats"}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:16},children:[{label:"Segments",value:a.length},{label:"Duration",value:`${Math.round(n)}s`},{label:"Words",value:o},{label:"Avg words/seg",value:a.length>0?Math.round(o/a.length):0}].map(({label:s,value:i})=>t.jsxs("div",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",borderRadius:6,padding:"8px 10px"},children:[t.jsx("div",{style:{fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",marginBottom:2},children:s}),t.jsx("div",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",fontWeight:600},children:i})]},s))}),a.length>0&&t.jsxs(t.Fragment,{children:[t.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"First Segment"}),t.jsx("pre",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",padding:8,borderRadius:6,overflowX:"auto",whiteSpace:"pre-wrap",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",fontFamily:"monospace"},children:JSON.stringify(a[0],null,2)}),t.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Last Segment"}),t.jsx("pre",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",padding:8,borderRadius:6,overflowX:"auto",whiteSpace:"pre-wrap",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",fontFamily:"monospace"},children:JSON.stringify(a[a.length-1],null,2)})]})]})}function be({triggerContainer:a,panelContainer:e}){const[r,o]=h.useState(!1),[n,s]=h.useState("transcript"),[i,p]=h.useState("idle"),[f,b]=h.useState(0),[T,S]=h.useState(""),[C,k]=h.useState(null),[R,j]=h.useState(null),[d,E]=h.useState([]),[l,g]=h.useState([]),[v,w]=h.useState(K),M=h.useRef(K),D=h.useRef(null);h.useEffect(()=>{chrome.runtime.sendMessage({type:"GET_SETTINGS"},u=>{u&&(w(u),M.current=u)})},[]);function B(u){w(u),M.current=u}h.useEffect(()=>{if(!r||i!=="idle")return;const u=pe(window.location.href);if(!u){S("Could not find a video on this page."),p("error");return}D.current=u,O(u)},[r]);async function O(u){try{p("fetching"),k(null),j(null);const{segments:x,diagnostics:A}=await ie(u);j(A);const U=de(x);if(E(U),M.current.semanticSearchEnabled)try{p("embedding");const H=await ue(U,re=>b(re));g(H)}catch(H){console.warn("[YT Transcript] Embedding failed, falling back to exact search:",H)}p("ready")}catch(x){S("Failed to load transcript."),k(x instanceof Error?x.stack||x.message:String(x));const A=x.diagnostics;A&&j(A),p("error")}}const c=[{id:"transcript",label:"Transcript"},{id:"chat",label:"AI Chat"},{id:"details",label:"Details"}],m=l.length>0?l:d.map((u,x)=>({...u,embedding:[],index:x})),$=t.jsxs("button",{onClick:()=>o(u=>!u),title:r?"Close transcript panel":"Open Transcript & AI",style:{display:"inline-flex",alignItems:"center",gap:"6px",background:r?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-badge-chip-background, #272727)",color:r?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",border:"none",borderRadius:"18px",padding:"0 12px",height:"36px",cursor:"pointer",fontFamily:"'Roboto', 'Arial', sans-serif",fontSize:"14px",fontWeight:500,whiteSpace:"nowrap",transition:"background 0.15s, color 0.15s",flexShrink:0},children:[t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",children:t.jsx("path",{d:"M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"})}),"Transcript & AI"]}),y=r?t.jsxs("div",{className:"yt-transcript-ext",tabIndex:-1,style:{background:"var(--yt-spec-brand-background-solid, #212121)",borderRadius:"12px",overflow:"hidden",marginBottom:"16px",fontFamily:"'Roboto', 'Arial', sans-serif",color:"var(--yt-spec-text-primary, #f1f1f1)"},children:[t.jsxs("div",{style:{padding:"12px 16px 0",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px"},children:[t.jsx("span",{style:{fontWeight:700,fontSize:14,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:"Transcript & AI"}),t.jsxs("span",{style:{marginLeft:"auto",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i==="ready"&&`${d.length} chunks`,i==="embedding"&&`Embedding… ${f}%`,i==="fetching"&&"Fetching…"]}),t.jsx("button",{onClick:()=>o(!1),title:"Close",style:{marginLeft:8,background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:20,lineHeight:1,padding:"0 2px",flexShrink:0,fontFamily:"inherit"},children:"×"})]}),t.jsx("div",{style:{display:"flex",gap:"8px",paddingBottom:"12px",flexWrap:"wrap"},children:c.map(u=>t.jsx("button",{type:"button",onMouseDown:x=>{x.preventDefault(),x.stopPropagation()},onClick:x=>{var A;x.preventDefault(),x.stopPropagation(),(A=document.activeElement)==null||A.blur(),s(u.id)},style:{padding:"0 12px",height:"32px",borderRadius:"16px",border:"none",background:n===u.id?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))",color:n===u.id?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",cursor:"pointer",fontSize:"13px",fontWeight:n===u.id?600:400,fontFamily:"inherit",transition:"background 0.15s, color 0.15s",whiteSpace:"nowrap"},children:u.label},u.id))})]}),t.jsxs("div",{tabIndex:-1,style:{maxHeight:"480px",overflow:"hidden",display:"flex",flexDirection:"column"},children:[i==="error"&&t.jsxs("div",{style:{flex:1,minHeight:0,overflow:"hidden",display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{padding:16,color:"#f87171",fontSize:13,borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"},children:[T," Check the ",t.jsx("strong",{children:"Details"})," tab for more information."]}),n==="details"&&t.jsx(Q,{segments:d,errorDetails:C,diagnostics:R})]}),(i==="fetching"||i==="embedding")&&t.jsxs("div",{style:{padding:24,textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:[t.jsx("div",{style:{marginBottom:8},children:i==="fetching"?"Fetching transcript…":`Building search index… ${f}%`}),t.jsx("div",{style:{height:3,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:2,overflow:"hidden"},children:t.jsx("div",{style:{height:"100%",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",width:i==="fetching"?"30%":`${f}%`,transition:"width 0.3s"}})})]}),i==="ready"&&t.jsxs(t.Fragment,{children:[n==="transcript"&&t.jsx(me,{segments:m,semanticEnabled:v.semanticSearchEnabled&&l.length>0}),n==="chat"&&t.jsx(ge,{segments:d,settings:v,onSettingsChange:B}),n==="details"&&t.jsx(Q,{segments:d,errorDetails:C,diagnostics:R})]}),i==="idle"&&t.jsx("div",{style:{padding:24,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:"Opening panel…"})]})]}):null;return t.jsxs(t.Fragment,{children:[_.createPortal($,a),_.createPortal(y??t.jsx(t.Fragment,{}),e)]})}function ve(){return document.querySelector("#top-level-buttons-computed")??document.querySelector("ytd-watch-metadata #top-level-buttons")??document.querySelector("#actions #top-level-buttons")??document.querySelector("#actions-inner")??null}function Se(){return document.querySelector("#secondary-inner")??document.querySelector("#secondary")??null}function ke(){return document.querySelector("#description-inner")??document.querySelector("#description")??null}function we(a){function e(){const o=ve(),n=Se(),s=ke(),i=n??s,p=n?"secondary":"description";return o&&i?(a(o,i,p),!0):!1}if(e())return new MutationObserver(()=>{});const r=new MutationObserver(()=>{e()&&r.disconnect()});return r.observe(document.body,{childList:!0,subtree:!0}),r}let P=null,I=null,z=null,F=null,N=null,L=null;function Te(){P==null||P.unmount(),P=null,I==null||I.remove(),I=null,z==null||z.remove(),z=null,F==null||F.remove(),F=null,N==null||N.disconnect(),N=null,L==null||L.disconnect(),L=null}function je(a,e,r){document.getElementById("yt-transcript-app-host")||(z=document.createElement("div"),z.id="yt-transcript-trigger",z.style.cssText="display:inline-flex;align-items:center;margin-right:8px;",a.prepend(z),F=document.createElement("div"),F.id="yt-transcript-panel",r==="secondary"?e.prepend(F):e.insertAdjacentElement("afterend",F),I=document.createElement("div"),I.id="yt-transcript-app-host",I.style.cssText="position:absolute;left:-9999px;top:-9999px;width:0;height:0;overflow:hidden;pointer-events:none;",document.body.appendChild(I),P=ne(I),P.render(t.jsx(be,{triggerContainer:z,panelContainer:F})))}function Z(){N=we(je)}function W(){if(document.querySelector("#player")){Z();return}L=new MutationObserver(()=>{document.querySelector("#player")&&(L.disconnect(),L=null,Z())}),L.observe(document.body,{childList:!0,subtree:!0})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W();document.addEventListener("yt-navigate-finish",()=>{Te(),setTimeout(W,500)});
