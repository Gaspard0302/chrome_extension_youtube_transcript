import{r as h,j as e,R as re,a as V,c as ie}from"./client-B-OClMmu.js";import{P as _,D as Y}from"./providers-B-uW_wjG.js";function le(r){var a;const t=r.split('"captions":');if(t.length<=1)return[];try{const o=t[1].split(',"videoDetails')[0].replace(/\n/g,""),s=JSON.parse(o),n=(a=s==null?void 0:s.playerCaptionsTracklistRenderer)==null?void 0:a.captionTracks;if(Array.isArray(n)&&n.length>0)return n}catch{}return[]}function ce(){var t,a;const r=document.querySelector('script[id="ytInitialPlayerResponse"]');if(r!=null&&r.textContent)try{const o=JSON.parse(r.textContent),s=(a=(t=o==null?void 0:o.captions)==null?void 0:t.playerCaptionsTracklistRenderer)==null?void 0:a.captionTracks;if(Array.isArray(s)&&s.length>0)return s}catch{}for(const o of document.querySelectorAll("script")){const s=o.textContent??"";if(s.includes('"captionTracks"')){const n=le(s);if(n.length>0)return n}}throw new Error("No captions found. This video may not have a transcript.")}async function de(r){var s,n;const t=await fetch("https://www.youtube.com/youtubei/v1/player?prettyPrint=false",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"ANDROID",clientVersion:"20.10.38"}},videoId:r})});if(!t.ok)throw new Error(`Innertube player returned ${t.status}`);const a=await t.json(),o=(n=(s=a==null?void 0:a.captions)==null?void 0:s.playerCaptionsTracklistRenderer)==null?void 0:n.captionTracks;return Array.isArray(o)?o:[]}async function pe(r){var i,l,d,g,u,y,$,k,w,j;const t={steps:[]};let a=[],o=null;try{a=await de(r),t.steps.push({label:"Page fetch caption tracks",status:a.length>0?"ok":"warn",detail:a.length>0?`Found ${a.length} track(s): ${a.map(c=>`${c.languageCode}${c.kind?` [${c.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(c){o=c instanceof Error?c.message:String(c),t.steps.push({label:"Page fetch caption tracks",status:"error",detail:o})}if(a.length===0)try{a=ce(),t.steps.push({label:"DOM fallback caption tracks",status:a.length>0?"ok":"warn",detail:a.length>0?`Found ${a.length} track(s): ${a.map(c=>`${c.languageCode}${c.kind?` [${c.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(c){const S=c instanceof Error?c.message:String(c);throw t.steps.push({label:"DOM fallback caption tracks",status:"error",detail:S}),Object.assign(new Error(`Could not find any caption tracks.
Background: ${o??"n/a"}
DOM: ${S}`),{diagnostics:t})}if(a.length===0)throw t.steps.push({label:"Select track",status:"error",detail:"No tracks available to select."}),Object.assign(new Error("No caption tracks found in background fetch or DOM."),{diagnostics:t});const s=a.find(c=>c.languageCode==="en"&&!c.kind)??a.find(c=>c.languageCode==="en")??a[0];t.steps.push({label:"Select track",status:"ok",detail:`Using "${((i=s.name)==null?void 0:i.simpleText)??"unknown"}" (lang=${s.languageCode}, kind=${s.kind??"manual"})`});try{const c=new TextEncoder,S=c.encode(r),f=c.encode(s.languageCode),x=btoa(String.fromCharCode(10,S.length,...S,18,f.length,...f)),v=await fetch("https://www.youtube.com/youtubei/v1/get_transcript?prettyPrint=false",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"WEB",clientVersion:"2.20241126.01.00",hl:"en",gl:"US"}},params:x})});if(v.ok){const T=await v.json(),E=((k=($=(y=(u=(g=(d=(l=T==null?void 0:T.actions)==null?void 0:l[0])==null?void 0:d.updateEngagementPanelAction)==null?void 0:g.content)==null?void 0:u.transcriptRenderer)==null?void 0:y.body)==null?void 0:$.transcriptBodyRenderer)==null?void 0:k.cueGroups)??[],A=[];for(const N of E)for(const D of((w=N==null?void 0:N.transcriptCueGroupRenderer)==null?void 0:w.cues)??[]){const R=D==null?void 0:D.transcriptCueRenderer,F=(((j=R==null?void 0:R.cue)==null?void 0:j.simpleText)??"").trim(),p=parseInt((R==null?void 0:R.startOffsetMs)??"0",10)/1e3,M=parseInt((R==null?void 0:R.durationMs)??"0",10)/1e3;F&&A.push({text:F,start:p,duration:M})}if(A.length>0)return t.steps.push({label:"get_transcript API",status:"ok",detail:`${A.length} cues via Innertube get_transcript`}),{segments:A,tracksLen:a.length,diagnostics:t}}t.steps.push({label:"get_transcript API",status:"warn",detail:`status=${v.status}, no cues — falling back to timedtext`})}catch(c){t.steps.push({label:"get_transcript API",status:"warn",detail:`Error: ${c instanceof Error?c.message:String(c)} — falling back to timedtext`})}let n;try{n=await ue(s.baseUrl,t)}catch(c){const S=c instanceof Error?c.message:String(c);throw Object.assign(new Error(S),{diagnostics:t})}return{segments:n,tracksLen:a.length,diagnostics:t}}async function ue(r,t){const a=(()=>{try{const n=new URL(r);return n.searchParams.delete("exp"),n.toString()}catch{return r}})();r!==a&&t.steps.push({label:"Stripped exp param",status:"ok",detail:"Removed exp=xpe from timedtext URL to disable POT enforcement."});let o="skipped";try{const n=a+"&fmt=json3",i=await fetch(n,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),l=i.headers.get("content-length")??"unknown",d=await i.text();if(t.steps.push({label:"HTTP response (JSON3)",status:d.length>0?"ok":"error",detail:`status=${i.status}, content-length=${l}, body=${d.length} bytes, preview: ${JSON.stringify(d.slice(0,200))}`}),o=`${d.length} bytes`,d){const g=JSON.parse(d),u=[];for(const y of g.events??[]){if(!y.segs)continue;const $=y.segs.map(k=>k.utf8).join("").replace(/\n/g," ").trim();$&&u.push({text:$,start:y.tStartMs/1e3,duration:y.dDurationMs/1e3})}if(u.length>0)return t.steps.push({label:"Fetch JSON3 transcript",status:"ok",detail:`${u.length} events, ${o}`}),u;o+=" (0 events after filtering)"}else o="empty body"}catch(n){o=`Error: ${n instanceof Error?n.message:String(n)}`}t.steps.push({label:"Fetch JSON3 transcript",status:"warn",detail:o+" — falling back to XML"});let s="skipped";try{const n=await fetch(a,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),i=n.headers.get("content-length")??"unknown",l=await n.text();t.steps.push({label:"HTTP response (XML)",status:l.length>0?"ok":"error",detail:`status=${n.status}, content-length=${i}, body=${l.length} bytes, preview: ${JSON.stringify(l.slice(0,200))}`}),s=`${l.length} bytes`;const d=fe(l);return t.steps.push({label:"Fetch XML transcript",status:"ok",detail:`${d.length} segments, ${s}`}),d}catch(n){const i=n instanceof Error?n.message:String(n);throw t.steps.push({label:"Fetch XML transcript",status:"error",detail:`${s} — ${i}`}),new Error(i)}}function G(r){return r.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/\n/g," ").trim()}function fe(r){const t=new DOMParser().parseFromString(r,"text/xml"),a=[],o=t.querySelectorAll("p");if(o.length>0){for(const s of o){const n=parseFloat(s.getAttribute("t")??"0"),i=parseFloat(s.getAttribute("d")??"0"),l=s.querySelectorAll("s"),d=l.length>0?Array.from(l).map(u=>u.textContent??"").join(""):s.textContent??"",g=G(d);g&&a.push({text:g,start:n/1e3,duration:i/1e3})}if(a.length>0)return a}for(const s of t.querySelectorAll("text")){const n=parseFloat(s.getAttribute("start")??"0"),i=parseFloat(s.getAttribute("dur")??"0"),l=G(s.textContent??"");l&&a.push({text:l,start:n,duration:i})}if(a.length===0)throw new Error(`XML parsed but yielded 0 segments. XML snippet: ${r.slice(0,300)}`);return a}function he(r,t=80){const a=[];let o="",s=0,n=0;for(const i of r)o.split(/\s+/).filter(Boolean).length>=t&&o.length>0?(a.push({text:o.trim(),start:s,duration:n}),o=i.text,s=i.start,n=i.duration):(o||(s=i.start,n=0),o+=(o?" ":"")+i.text,n=i.start+i.duration-s);return o.trim()&&a.push({text:o.trim(),start:s,duration:n}),a}function J(r){const t=Math.floor(r/3600),a=Math.floor(r%3600/60),o=Math.floor(r%60);return t>0?`${t}:${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`:`${a}:${String(o).padStart(2,"0")}`}function ge(r){const t=r.match(/[?&]v=([^&]+)/);return t?t[1]:null}async function ne(r){return new Promise((t,a)=>{chrome.runtime.sendMessage({type:"EMBED_TEXT",payload:{text:r}},o=>{chrome.runtime.lastError?a(new Error(chrome.runtime.lastError.message)):!o||o.error?a(new Error((o==null?void 0:o.error)??"No response from background")):t(o.embedding)})})}async function ye(r,t){const a=[];for(let o=0;o<r.length;o++){const s=r[o],n=await ne(s.text);a.push({...s,embedding:n,index:o}),t==null||t(Math.round((o+1)/r.length*100))}return a}function xe(r,t){if(r.length!==t.length||r.length===0)return 0;let a=0,o=0,s=0;for(let i=0;i<r.length;i++)a+=r[i]*t[i],o+=r[i]*r[i],s+=t[i]*t[i];const n=Math.sqrt(o)*Math.sqrt(s);return n===0?0:Math.max(-1,Math.min(1,a/n))}function me(r,t,a=5){const o=t.map(s=>({segment:s,score:xe(r,s.embedding)}));return o.sort((s,n)=>n.score-s.score),o.slice(0,a)}let ae=[];function be(r){ae=r}function ve(){return ae}function Se(r){const t=r.match(/^\[(\d+):(\d{2})(?::(\d{2}))?\]$/);if(!t)return null;const a=t[3]!==void 0?parseInt(t[1],10):0,o=t[3]!==void 0?parseInt(t[2],10):parseInt(t[1],10),s=t[3]!==void 0?parseInt(t[3],10):parseInt(t[2],10);return a*3600+o*60+s}function q(r,t,a){const o=/(\[\d+:\d{2}(?::\d{2})?\]|\*\*(?:[^*]|\*(?!\*))+?\*\*|\*[^*\n]+?\*|`[^`\n]+`)/g;return r.split(o).map((n,i)=>{const l=`${a}-${i}`,d=Se(n);return d!==null?e.jsx("button",{type:"button",onClick:()=>t(d),style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:4,color:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",cursor:"pointer",fontSize:12,fontWeight:700,padding:"1px 6px",margin:"0 2px",fontFamily:"inherit"},children:n},l):n.startsWith("**")&&n.endsWith("**")&&n.length>4?e.jsx("strong",{children:n.slice(2,-2)},l):n.startsWith("*")&&n.endsWith("*")&&n.length>2?e.jsx("em",{children:n.slice(1,-1)},l):n.startsWith("`")&&n.endsWith("`")&&n.length>2?e.jsx("code",{style:{background:"rgba(0,0,0,0.35)",borderRadius:3,padding:"1px 5px",fontSize:"0.88em",fontFamily:"monospace"},children:n.slice(1,-1)},l):e.jsx(re.Fragment,{children:n},l)})}function ke(r,t){const a=[],o=/```(\w*)\n?([\s\S]*?)```/g;let s=0,n;for(;(n=o.exec(r))!==null;)n.index>s&&a.push({t:"text",text:r.slice(s,n.index)}),a.push({t:"code",lang:n[1]||"",code:n[2].replace(/\n$/,"")}),s=n.index+n[0].length;return s<r.length&&a.push({t:"text",text:r.slice(s)}),e.jsx("div",{style:{lineHeight:1.65},children:a.map((i,l)=>{if(i.t==="code")return e.jsx("pre",{style:{background:"rgba(0,0,0,0.45)",borderRadius:6,padding:"8px 10px",overflowX:"auto",fontSize:12,margin:"6px 0",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-all"},children:e.jsx("code",{children:i.code})},l);const d=i.text.split(`
`),g=[];let u=0;for(;u<d.length;){const y=d[u];if(!y.trim()){u++;continue}const $=y.match(/^(#{1,3}) (.+)/);if($){const k=$[1].length;g.push(e.jsx("div",{style:{fontWeight:700,fontSize:k===1?15:14,margin:"8px 0 3px",color:"var(--yt-spec-text-primary, #f1f1f1)"},children:q($[2],t,`${l}-h-${u}`)},`${l}-h-${u}`)),u++;continue}if(/^[-*+] /.test(y)){const k=[];for(;u<d.length&&/^[-*+] /.test(d[u]);)k.push(e.jsx("li",{style:{marginBottom:2},children:q(d[u].slice(2),t,`${l}-li-${u}`)},u)),u++;g.push(e.jsx("ul",{style:{paddingLeft:18,margin:"3px 0"},children:k},`${l}-ul-${u}`));continue}if(/^\d+\. /.test(y)){const k=[];for(;u<d.length&&/^\d+\. /.test(d[u]);)k.push(e.jsx("li",{style:{marginBottom:2},children:q(d[u].replace(/^\d+\. /,""),t,`${l}-oli-${u}`)},u)),u++;g.push(e.jsx("ol",{style:{paddingLeft:18,margin:"3px 0"},children:k},`${l}-ol-${u}`));continue}if(y.startsWith("> ")){g.push(e.jsx("blockquote",{style:{borderLeft:"3px solid rgba(255,255,255,0.2)",paddingLeft:8,margin:"4px 0",color:"var(--yt-spec-text-secondary, #aaa)",fontStyle:"italic"},children:q(y.slice(2),t,`${l}-bq-${u}`)},`${l}-bq-${u}`)),u++;continue}if(/^---+$/.test(y.trim())){g.push(e.jsx("hr",{style:{border:"none",borderTop:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",margin:"8px 0"}},`${l}-hr-${u}`)),u++;continue}g.push(e.jsx("p",{style:{margin:"0 0 5px"},children:q(y,t,`${l}-p-${u}`)},`${l}-p-${u}`)),u++}return e.jsx(re.Fragment,{children:g},l)})})}function we({segments:r,settings:t,onSettingsChange:a,videoId:o}){const[s,n]=h.useState([]),[i,l]=h.useState(""),[d,g]=h.useState(!1),[u,y]=h.useState(null),[$,k]=h.useState(""),w=h.useRef(null),j=h.useRef(""),c=_.filter(p=>!p.requiresKey||(t.apiKeys[p.id]??"").length>0),S=c.length>0,f=c.find(p=>p.id===t.selectedProvider)??c[0]??null,x=_.find(p=>p.id===t.selectedProvider),v=t.apiKeys[t.selectedProvider]??"",T=!(x!=null&&x.requiresKey)||v.length>0,E=!!t.selectedModel;h.useEffect(()=>{if(!t.selectedModel&&c.length>0){const p=c[0];a({...t,selectedProvider:p.id,selectedModel:p.models[0].id})}},[c.length,t.selectedModel]),h.useEffect(()=>{if(o)try{const p=sessionStorage.getItem(`yt-transcript-chat:${o}`);p&&n(JSON.parse(p))}catch{}},[o]),h.useEffect(()=>{if(o)try{s.length>0?sessionStorage.setItem(`yt-transcript-chat:${o}`,JSON.stringify(s)):sessionStorage.removeItem(`yt-transcript-chat:${o}`)}catch{}},[s,o]),h.useEffect(()=>{const p=w.current;p&&(p.scrollTop=p.scrollHeight)},[s,d,u]);function A(){n([]),o&&sessionStorage.removeItem(`yt-transcript-chat:${o}`)}function N(){const p=r.length>0?r[r.length-1].start+(r[r.length-1].duration||0):0,M=Math.round(p/60);return`You are a helpful assistant answering questions about a YouTube video based on its transcript.

You have access to a \`search_transcript\` tool that retrieves up to 15 relevant transcript segments for a given query.
ALWAYS use this tool to find relevant context before answering — never answer content questions from memory alone.
You may search up to 3 times using different queries to gather all necessary information.

Video info: ${r.length} transcript segments, approximately ${M} minutes long.

When referencing video content, ALWAYS cite the exact timestamp in [MM:SS] or [H:MM:SS] format — these render as clickable seek buttons in the UI.

Guidelines:
- Search first, answer second — always search before responding to content questions
- Use different search angles if one query isn't enough
- Include a timestamp for every specific claim, quote, or reference from the video
- Be concise and direct`}async function D(){if(!i.trim()||d)return;const p={role:"user",content:i.trim()},M=[...s,p];n(M),l(""),g(!0),k(""),y(null),j.current="",n(b=>[...b,{role:"assistant",content:""}]);const m=b=>{if(b.type==="CHAT_SEARCHING"){y(b.payload.query??null);return}b.type==="CHAT_CHUNK"&&(y(null),j.current=b.payload.fullText??"",n(C=>{const P=[...C];return P[P.length-1]={role:"assistant",content:j.current},P}))};chrome.runtime.onMessage.addListener(m);try{const b=await chrome.runtime.sendMessage({type:"CHAT_STREAM",payload:{messages:M.map(C=>({role:C.role,content:C.content})),systemPrompt:N(),provider:t.selectedProvider,model:t.selectedModel,apiKey:v,ollamaBaseUrl:t.ollamaBaseUrl}});b!=null&&b.error&&(k(b.error),n(C=>C.slice(0,-1)))}catch(b){k(b instanceof Error?b.message:"Unknown error"),n(C=>C.slice(0,-1))}finally{chrome.runtime.onMessage.removeListener(m),g(!1),y(null)}}function R(p){p.key==="Enter"&&!p.shiftKey&&(p.preventDefault(),D())}function F(p){const M=document.querySelector("video");M&&(M.currentTime=p,M.play())}return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"8px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",gap:6,alignItems:"center",flexShrink:0},children:[S?e.jsxs(e.Fragment,{children:[e.jsx("select",{value:(f==null?void 0:f.id)??"",onChange:p=>{const M=c.find(m=>m.id===p.target.value);a({...t,selectedProvider:M.id,selectedModel:M.models[0].id})},style:X,children:c.map(p=>e.jsx("option",{value:p.id,children:p.label},p.id))}),e.jsx("select",{value:t.selectedModel,onChange:p=>a({...t,selectedModel:p.target.value}),style:X,children:((f==null?void 0:f.models)??[]).map(p=>e.jsx("option",{value:p.id,children:p.label},p.id))})]}):e.jsx("span",{style:{fontSize:12,color:"#fbbf24"},children:"No API provider configured. Add an API key in the extension settings."}),s.length>0&&e.jsx("button",{type:"button",onClick:A,title:"Clear chat history",style:{background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",padding:4,borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"color 0.15s"},onMouseEnter:p=>p.currentTarget.style.color="var(--yt-spec-text-primary, #f1f1f1)",onMouseLeave:p=>p.currentTarget.style.color="var(--yt-spec-text-secondary, #aaa)",children:e.jsx("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",children:e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})})})]}),!T&&e.jsxs("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(42,26,0,0.8)",border:"1px solid rgba(124,74,0,0.8)",borderRadius:6,fontSize:12,color:"#fbbf24",flexShrink:0},children:["No API key set for ",x==null?void 0:x.label,". Add one in the extension settings."]}),T&&!E&&e.jsx("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",borderRadius:6,fontSize:12,color:"var(--yt-spec-text-secondary, #aaa)",flexShrink:0},children:"Select a model in the extension settings to use AI Chat."}),e.jsxs("div",{ref:w,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"12px",display:"flex",flexDirection:"column",gap:10},children:[s.length===0&&e.jsxs("div",{style:{textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13,marginTop:16,lineHeight:1.7},children:["Ask anything about this video.",e.jsx("br",{}),e.jsx("span",{style:{fontSize:11},children:"The AI will search the transcript up to 3 times. Timestamps are clickable."})]}),s.map((p,M)=>{const m=d&&M===s.length-1&&p.role==="assistant";return e.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:p.role==="user"?"flex-end":"flex-start"},children:e.jsx("div",{style:{maxWidth:"90%",padding:"9px 12px",borderRadius:p.role==="user"?"12px 12px 2px 12px":"12px 12px 12px 2px",background:p.role==="user"?"var(--yt-spec-call-to-action-inverse-color, #cc0000)":"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",fontSize:13,lineHeight:1.6,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:p.role==="assistant"?p.content?ke(p.content,F):m?e.jsx("span",{style:{color:"var(--yt-spec-text-secondary, #aaa)",fontSize:12,fontStyle:"italic"},children:u?`Searching: "${u}"…`:"▋"}):null:p.content})},M)}),$&&e.jsxs("div",{style:{color:"#f87171",fontSize:12,padding:"4px 0"},children:["Error: ",$]})]}),e.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0,background:"var(--yt-spec-brand-background-solid, #212121)"},children:[e.jsx("textarea",{value:i,onChange:p=>l(p.target.value),onKeyDown:R,placeholder:"Ask about the video… (Enter to send)",disabled:d||!T||!E||!S,rows:1,style:{flex:1,background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:20,padding:"9px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:100,overflow:"auto",boxSizing:"border-box"},onFocus:p=>p.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:p=>p.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))"}),e.jsx("button",{onClick:D,disabled:d||!i.trim()||!T||!E||!S,style:{background:d||!i.trim()||!T||!E||!S?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))":"var(--yt-spec-call-to-action-inverse-color, #ff0000)",border:"none",borderRadius:"50%",color:"var(--yt-spec-static-brand-white, #fff)",cursor:d||!i.trim()||!T||!E||!S?"default":"pointer",width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:700,transition:"background 0.15s",flexShrink:0,fontFamily:"inherit"},children:d?"…":"↑"})]})]})}const X={background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:16,color:"var(--yt-spec-text-primary, #f1f1f1)",padding:"5px 10px",fontSize:12,cursor:"pointer",flex:1,outline:"none",fontFamily:"'Roboto', 'Arial', sans-serif"};function H(r,t){if(!r.trim())return[];const a=r.toLowerCase().trim(),o=[];for(let s=0;s<t.length;s++){const n=t[s];n.text.toLowerCase().includes(a)&&o.push({segment:n,index:s,score:1,matchType:"exact"})}return o}async function se(r,t,a=8){if(!r.trim())return[];const o=H(r,t),s=new Set(o.map(d=>d.index)),n=await ne(r),i=me(n,t,a),l=[...o];for(const{segment:d,score:g}of i)!s.has(d.index)&&g>.3&&l.push({segment:d,index:d.index,score:g,matchType:"semantic"});return l.sort((d,g)=>d.matchType==="exact"&&g.matchType!=="exact"?-1:g.matchType==="exact"&&d.matchType!=="exact"?1:g.score-d.score),l}function Q(r,t){if(!t.trim())return r;const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return r.replace(new RegExp(`(${a})`,"gi"),"<mark>$1</mark>")}function je({segments:r,semanticEnabled:t}){const[a,o]=h.useState(null),[s,n]=h.useState(""),[i,l]=h.useState(null),[d,g]=h.useState(!1),u=h.useRef(null),y=h.useRef(null);h.useEffect(()=>{const f=document.querySelector("video");if(!f)return;function x(){const v=f.currentTime;let T=0;for(let E=0;E<r.length&&r[E].start<=v;E++)T=E;o(T)}return f.addEventListener("timeupdate",x),()=>f.removeEventListener("timeupdate",x)},[r]),h.useEffect(()=>{var x;if(a===null||i!==null)return;const f=(x=u.current)==null?void 0:x.querySelector(`[data-index="${a}"]`);f==null||f.scrollIntoView({block:"nearest",behavior:"smooth"})},[a,i]);function $(f){const x=document.querySelector("video");x&&(x.currentTime=f,x.play())}const k=h.useCallback(async f=>{if(!f.trim()){l(null);return}g(!0);try{const x=t?await se(f,r):H(f,r).map(v=>({...v}));l(x.map(v=>({segment:v.segment,highlighted:Q(v.segment.text,f),matchType:v.matchType})))}catch{const x=H(f,r).map(v=>({segment:v.segment,highlighted:Q(v.segment.text,f),matchType:v.matchType}));l(x)}finally{g(!1)}},[r,t]);function w(f){const x=f.target.value;if(n(x),y.current&&clearTimeout(y.current),!x.trim()){l(null);return}y.current=setTimeout(()=>k(x),300)}function j(){y.current&&(clearTimeout(y.current),y.current=null);const f=s.trim();if(!f){l(null);return}k(f)}function c(f){f.key==="Enter"&&(f.preventDefault(),j())}const S=i!==null?i:r.map(f=>({segment:f,highlighted:"",matchType:""}));return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",flexShrink:0},children:[e.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[e.jsxs("div",{style:{position:"relative",flex:1},children:[e.jsx("input",{type:"text",value:s,onChange:w,onKeyDown:c,placeholder:t?"Filter by meaning or keyword…":"Filter transcript…",style:{width:"100%",background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:"20px",padding:"8px 32px 8px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,outline:"none",fontFamily:"inherit",boxSizing:"border-box"},onFocus:f=>f.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:f=>f.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"}),d?e.jsx("div",{style:{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",width:14,height:14,border:"2px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.2))",borderTopColor:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",borderRadius:"50%",animation:"yt-transcript-spin 0.6s linear infinite"}}):s?e.jsx("button",{onClick:()=>{n(""),l(null)},style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:16,lineHeight:1,padding:0,fontFamily:"inherit"},title:"Clear search",children:"×"}):null]}),e.jsx("button",{type:"button",onClick:j,disabled:d||!s.trim(),style:{flexShrink:0,padding:"8px 14px",borderRadius:"18px",border:"none",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",color:"var(--yt-spec-static-brand-white, #fff)",fontSize:13,fontWeight:600,cursor:d||!s.trim()?"default":"pointer",fontFamily:"inherit",opacity:d||!s.trim()?.6:1},children:"Search"})]}),s&&i!==null&&e.jsxs("p",{style:{margin:"4px 0 0",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i.length===0?"No results":`${i.length} result${i.length===1?"":"s"}`,t&&" · AI semantic search active"]})]}),e.jsxs("div",{ref:u,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"4px 0"},children:[S.length===0&&s&&e.jsxs("div",{style:{padding:"16px 12px",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:["No results for “",s,"”"]}),S.map(({segment:f,highlighted:x,matchType:v})=>{const T=!s&&a===f.index;return e.jsxs("div",{"data-index":f.index,onClick:()=>$(f.start),style:{padding:"8px 12px",cursor:"pointer",background:T?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))":"transparent",borderLeft:T?"3px solid var(--yt-spec-call-to-action-inverse-color, #ff0000)":"3px solid transparent",transition:"background 0.15s"},onMouseEnter:E=>{T||(E.currentTarget.style.background="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))")},onMouseLeave:E=>{T||(E.currentTarget.style.background="transparent")},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:2},children:[e.jsx("span",{style:{fontSize:11,fontWeight:700,color:T?"var(--yt-spec-call-to-action-inverse-color, #ff0000)":"var(--yt-spec-text-secondary, #aaa)",fontVariantNumeric:"tabular-nums"},children:J(f.start)}),v==="semantic"&&e.jsx("span",{style:{fontSize:10,background:"rgba(59,130,246,0.15)",color:"#60a5fa",borderRadius:3,padding:"1px 5px",fontWeight:600},children:"AI"})]}),x?e.jsx("p",{style:{margin:0,fontSize:13,color:"var(--yt-spec-text-primary, #f1f1f1)",lineHeight:1.5},dangerouslySetInnerHTML:{__html:x}}):e.jsx("p",{style:{margin:0,fontSize:13,color:T?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-text-secondary, #aaa)",lineHeight:1.5},children:f.text})]},f.index)})]})]})}const Z={ok:"#4ade80",warn:"#facc15",error:"#f87171"},Te={ok:"✓",warn:"⚠",error:"✗"};function ee({segments:r,errorDetails:t,diagnostics:a}){const o=r.reduce((n,i)=>n+i.text.split(" ").length,0),s=r.length>0?r[r.length-1].start+r[r.length-1].duration:0;return e.jsxs("div",{style:{padding:16,fontSize:13,color:"var(--yt-spec-text-secondary, #aaa)",overflowY:"auto",flex:1,minHeight:0},children:[e.jsx("h3",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:12,fontSize:14,fontWeight:600},children:"Debug Details"}),a&&a.steps.length>0&&e.jsxs("div",{style:{marginBottom:20},children:[e.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Pipeline Steps"}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:a.steps.map((n,i)=>e.jsxs("div",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",borderRadius:6,padding:"8px 10px",borderLeft:`3px solid ${Z[n.status]??"var(--yt-spec-text-secondary, #555)"}`},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:n.detail?4:0},children:[e.jsx("span",{style:{color:Z[n.status]??"var(--yt-spec-text-secondary, #555)",fontWeight:700,fontSize:12,minWidth:14},children:Te[n.status]??"?"}),e.jsx("span",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",fontWeight:500},children:n.label})]}),n.detail&&e.jsx("div",{style:{marginLeft:20,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:11,wordBreak:"break-all"},children:n.detail})]},i))})]}),t&&e.jsxs("div",{style:{marginBottom:20,padding:12,background:"rgba(248,113,113,0.08)",border:"1px solid #f87171",color:"#f87171",borderRadius:6},children:[e.jsx("strong",{style:{display:"block",marginBottom:6,fontSize:11,textTransform:"uppercase",letterSpacing:"0.05em"},children:"Full Error Trace"}),e.jsx("pre",{style:{margin:0,whiteSpace:"pre-wrap",fontSize:11,wordBreak:"break-all",fontFamily:"monospace"},children:t})]}),e.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginTop:0,marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Transcript Stats"}),e.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginBottom:16},children:[{label:"Segments",value:r.length},{label:"Duration",value:`${Math.round(s)}s`},{label:"Words",value:o},{label:"Avg words/seg",value:r.length>0?Math.round(o/r.length):0}].map(({label:n,value:i})=>e.jsxs("div",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",borderRadius:6,padding:"8px 10px"},children:[e.jsx("div",{style:{fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",marginBottom:2},children:n}),e.jsx("div",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",fontWeight:600},children:i})]},n))}),r.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"First Segment"}),e.jsx("pre",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",padding:8,borderRadius:6,overflowX:"auto",whiteSpace:"pre-wrap",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",fontFamily:"monospace"},children:JSON.stringify(r[0],null,2)}),e.jsx("h4",{style:{color:"var(--yt-spec-text-primary, #f1f1f1)",marginBottom:8,fontSize:12,textTransform:"uppercase",letterSpacing:"0.05em",fontWeight:600},children:"Last Segment"}),e.jsx("pre",{style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",padding:8,borderRadius:6,overflowX:"auto",whiteSpace:"pre-wrap",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)",fontFamily:"monospace"},children:JSON.stringify(r[r.length-1],null,2)})]})]})}function $e(r,t=15){if(!r.length)return[];const a=Math.max(1,Math.ceil(r.length/t)),o=r[r.length-1].start+(r[r.length-1].duration||60),s=[];for(let n=0;n<r.length;n+=a){const i=r.slice(n,n+a),l=i[0].start,d=n+a<r.length?r[n+a].start:o;s.push({startTime:l,endTime:d,title:null,segments:i})}return s}function Ee({segments:r,settings:t}){const[a,o]=h.useState([]),[s,n]=h.useState(!1),[i,l]=h.useState(""),d=h.useRef(!1),u=_.filter(w=>!w.requiresKey||(t.apiKeys[w.id]??"").length>0).length>0,y=t.apiKeys[t.selectedProvider]??"";h.useEffect(()=>{r.length&&(o($e(r)),d.current=!1)},[r]),h.useEffect(()=>{a.length>0&&u&&!d.current&&!s&&(d.current=!0,$(a))},[a.length,u]);async function $(w){n(!0),l("");const j=w.map(c=>({startTime:c.startTime,endTime:c.endTime,text:c.segments.map(S=>S.text).join(" ").slice(0,600)}));try{const c=await chrome.runtime.sendMessage({type:"GENERATE_TIMELINE",payload:{blocks:j,provider:t.selectedProvider,model:t.selectedModel,apiKey:y,ollamaBaseUrl:t.ollamaBaseUrl}});if(c!=null&&c.error)l(c.error);else if(c!=null&&c.titles){const S=c.titles;o(f=>f.map((x,v)=>({...x,title:S[v]??`Segment ${v+1}`})))}}catch(c){l(c instanceof Error?c.message:"Unknown error")}finally{n(!1)}}function k(w){const j=document.querySelector("video");j&&(j.currentTime=w,j.play())}return r.length?e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[e.jsxs("div",{style:{padding:"8px 14px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",alignItems:"center",gap:8,flexShrink:0},children:[e.jsxs("span",{style:{fontSize:12,color:"var(--yt-spec-text-secondary, #aaa)",flex:1},children:[a.length," segments",s&&" · generating titles…",!u&&" · add an API key to generate titles"]}),u&&!s&&e.jsx("button",{type:"button",onClick:()=>{d.current=!0,$(a)},style:{background:"transparent",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.2))",borderRadius:12,color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:11,padding:"3px 10px",fontFamily:"inherit"},children:"Regenerate"})]}),i&&e.jsxs("div",{style:{padding:"6px 14px",fontSize:11,color:"#f87171",flexShrink:0},children:["Error: ",i]}),e.jsx("div",{className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"8px 0"},children:a.map((w,j)=>{const c=s&&w.title===null;return e.jsxs("div",{onClick:()=>k(w.startTime),style:{display:"flex",alignItems:"flex-start",gap:0,padding:"0 14px",cursor:"pointer"},onMouseEnter:S=>{S.currentTarget.style.background="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.04))"},onMouseLeave:S=>{S.currentTarget.style.background="transparent"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",width:20,flexShrink:0,paddingTop:14},children:[e.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",flexShrink:0}}),j<a.length-1&&e.jsx("div",{style:{width:2,flex:1,minHeight:24,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.12))",margin:"3px 0"}})]}),e.jsxs("div",{style:{flex:1,padding:"8px 0 8px 10px"},children:[e.jsx("span",{style:{fontSize:11,fontWeight:700,color:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",fontVariantNumeric:"tabular-nums",display:"block",marginBottom:2},children:J(w.startTime)}),c?e.jsx("div",{style:{height:12,width:"60%",borderRadius:6,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.08))",animation:"yt-transcript-pulse 1.2s ease-in-out infinite"}}):e.jsx("span",{style:{fontSize:13,color:w.title?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-text-secondary, #aaa)",lineHeight:1.4},children:w.title??`Segment ${j+1}`})]})]},j)})})]}):e.jsx("div",{style:{padding:24,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13,textAlign:"center"},children:"No transcript loaded."})}function Me({triggerContainer:r,panelContainer:t}){const[a,o]=h.useState(!1),[s,n]=h.useState("transcript"),[i,l]=h.useState("idle"),[d,g]=h.useState(0),[u,y]=h.useState(""),[$,k]=h.useState(null),[w,j]=h.useState(null),[c,S]=h.useState([]),[f,x]=h.useState([]),[v,T]=h.useState(Y),E=h.useRef(Y),A=h.useRef(null);h.useEffect(()=>{chrome.runtime.sendMessage({type:"GET_SETTINGS"},m=>{m&&(T(m),E.current=m)})},[]);function N(m){T(m),E.current=m}h.useEffect(()=>{if(!a||i!=="idle")return;const m=ge(window.location.href);if(!m){y("Could not find a video on this page."),l("error");return}A.current=m,D(m)},[a]);async function D(m){try{l("fetching"),k(null),j(null);const{segments:b,diagnostics:C}=await pe(m);j(C);const P=he(b);if(S(P),E.current.semanticSearchEnabled)try{l("embedding");const U=await ye(P,oe=>g(oe));x(U)}catch(U){console.warn("[YT Transcript] Embedding failed, falling back to exact search:",U)}l("ready")}catch(b){y("Failed to load transcript."),k(b instanceof Error?b.stack||b.message:String(b));const C=b.diagnostics;C&&j(C),l("error")}}const R=[{id:"transcript",label:"Transcript"},{id:"chat",label:"AI Chat"},{id:"timeline",label:"Timeline"},{id:"details",label:"Details"}],F=f.length>0?f:c.map((m,b)=>({...m,embedding:[],index:b}));h.useEffect(()=>{be(F)},[F]);const p=e.jsxs("button",{onClick:()=>o(m=>!m),title:a?"Close transcript panel":"Open Transcript & AI",style:{display:"inline-flex",alignItems:"center",gap:"6px",background:a?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-badge-chip-background, #272727)",color:a?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",border:"none",borderRadius:"18px",padding:"0 12px",height:"36px",cursor:"pointer",fontFamily:"'Roboto', 'Arial', sans-serif",fontSize:"14px",fontWeight:500,whiteSpace:"nowrap",transition:"background 0.15s, color 0.15s",flexShrink:0},children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",children:e.jsx("path",{d:"M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"})}),"Transcript & AI"]}),M=a?e.jsxs("div",{className:"yt-transcript-ext",tabIndex:-1,style:{background:"var(--yt-spec-brand-background-solid, #212121)",borderRadius:"12px",overflow:"hidden",marginBottom:"16px",fontFamily:"'Roboto', 'Arial', sans-serif",color:"var(--yt-spec-text-primary, #f1f1f1)"},children:[e.jsxs("div",{style:{padding:"12px 16px 0",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px"},children:[e.jsx("span",{style:{fontWeight:700,fontSize:14,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:"Transcript & AI"}),e.jsxs("span",{style:{marginLeft:"auto",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i==="ready"&&`${c.length} chunks`,i==="embedding"&&`Embedding… ${d}%`,i==="fetching"&&"Fetching…"]}),e.jsx("button",{onClick:()=>o(!1),title:"Close",style:{marginLeft:8,background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:20,lineHeight:1,padding:"0 2px",flexShrink:0,fontFamily:"inherit"},children:"×"})]}),e.jsx("div",{style:{display:"flex",gap:"8px",paddingBottom:"12px",flexWrap:"wrap"},children:R.map(m=>e.jsx("button",{type:"button",onMouseDown:b=>{b.preventDefault(),b.stopPropagation()},onClick:b=>{var C;b.preventDefault(),b.stopPropagation(),(C=document.activeElement)==null||C.blur(),n(m.id)},style:{padding:"0 12px",height:"32px",borderRadius:"16px",border:"none",background:s===m.id?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))",color:s===m.id?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",cursor:"pointer",fontSize:"13px",fontWeight:s===m.id?600:400,fontFamily:"inherit",transition:"background 0.15s, color 0.15s",whiteSpace:"nowrap"},children:m.label},m.id))})]}),e.jsxs("div",{tabIndex:-1,style:{maxHeight:"480px",overflow:"hidden",display:"flex",flexDirection:"column"},children:[i==="error"&&e.jsxs("div",{style:{flex:1,minHeight:0,overflow:"hidden",display:"flex",flexDirection:"column"},children:[e.jsxs("div",{style:{padding:16,color:"#f87171",fontSize:13,borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"},children:[u," Check the ",e.jsx("strong",{children:"Details"})," tab for more information."]}),s==="details"&&e.jsx(ee,{segments:c,errorDetails:$,diagnostics:w})]}),(i==="fetching"||i==="embedding")&&e.jsxs("div",{style:{padding:24,textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:[e.jsx("div",{style:{marginBottom:8},children:i==="fetching"?"Fetching transcript…":`Building search index… ${d}%`}),e.jsx("div",{style:{height:3,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:2,overflow:"hidden"},children:e.jsx("div",{style:{height:"100%",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",width:i==="fetching"?"30%":`${d}%`,transition:"width 0.3s"}})})]}),i==="ready"&&e.jsxs(e.Fragment,{children:[s==="transcript"&&e.jsx(je,{segments:F,semanticEnabled:v.semanticSearchEnabled&&f.length>0}),s==="chat"&&e.jsx(we,{segments:c,settings:v,onSettingsChange:N,videoId:A.current}),s==="timeline"&&e.jsx(Ee,{segments:c,settings:v}),s==="details"&&e.jsx(ee,{segments:c,errorDetails:$,diagnostics:w})]}),i==="idle"&&e.jsx("div",{style:{padding:24,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:"Opening panel…"})]})]}):null;return e.jsxs(e.Fragment,{children:[V.createPortal(p,r),V.createPortal(M??e.jsx(e.Fragment,{}),t)]})}function Ce(){return document.querySelector("#top-level-buttons-computed")??document.querySelector("ytd-watch-metadata #top-level-buttons")??document.querySelector("#actions #top-level-buttons")??document.querySelector("#actions-inner")??null}function Re(){return document.querySelector("#secondary-inner")??document.querySelector("#secondary")??null}function Ae(){return document.querySelector("#description-inner")??document.querySelector("#description")??null}function ze(r){function t(){const o=Ce(),s=Re(),n=Ae(),i=s??n,l=s?"secondary":"description";return o&&i?(r(o,i,l),!0):!1}if(t())return new MutationObserver(()=>{});const a=new MutationObserver(()=>{t()&&a.disconnect()});return a.observe(document.body,{childList:!0,subtree:!0}),a}let O=null,z=null,I=null,L=null,W=null,B=null;function Ie(){O==null||O.unmount(),O=null,z==null||z.remove(),z=null,I==null||I.remove(),I=null,L==null||L.remove(),L=null,W==null||W.disconnect(),W=null,B==null||B.disconnect(),B=null}function Le(r,t,a){document.getElementById("yt-transcript-app-host")||(I=document.createElement("div"),I.id="yt-transcript-trigger",I.style.cssText="display:inline-flex;align-items:center;margin-right:8px;",r.prepend(I),L=document.createElement("div"),L.id="yt-transcript-panel",a==="secondary"?t.prepend(L):t.insertAdjacentElement("afterend",L),z=document.createElement("div"),z.id="yt-transcript-app-host",z.style.cssText="position:absolute;left:-9999px;top:-9999px;width:0;height:0;overflow:hidden;pointer-events:none;",document.body.appendChild(z),O=ie(z),O.render(e.jsx(Me,{triggerContainer:I,panelContainer:L})))}function te(){W=ze(Le)}function K(){if(document.querySelector("#player")){te();return}B=new MutationObserver(()=>{document.querySelector("#player")&&(B.disconnect(),B=null,te())}),B.observe(document.body,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener((r,t,a)=>{var d;if(r.type!=="SEARCH_REQUEST")return!1;const o=((d=r.payload)==null?void 0:d.query)??"",s=ve();if(!s.length)return a({results:"No transcript loaded yet."}),!1;function n(g){return g.length?g.map(u=>`[${J(u.segment.start)}] ${u.segment.text}`).join(`
`):"No matching segments found."}if(s.some(g=>g.embedding.length>0))return se(o,s,15).then(g=>{a({results:n(g)})}).catch(()=>{const g=H(o,s).slice(0,15);a({results:n(g)})}),!0;const l=H(o,s).slice(0,15);return a({results:n(l)}),!1});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",K):K();document.addEventListener("yt-navigate-finish",()=>{Ie(),setTimeout(K,500)});
