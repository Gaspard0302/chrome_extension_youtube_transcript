import{r as u,j as n,c as H}from"./content-IBObJqNz.js";import{_ as N}from"./preload-helper-D7HrI6pR.js";import{P as M,D as O}from"./providers-D_NaGG7O.js";function W(e){const t='"captionTracks"',a=e.indexOf(t);if(a===-1)return null;const r=e.indexOf("[",a+t.length);if(r===-1)return null;let i=0,o=r;for(let s=r;s<Math.min(e.length,r+2e5);s++){const d=e[s];if(d==="["||d==="{")i++;else if((d==="]"||d==="}")&&(i--,i===0)){o=s;break}}try{const s=JSON.parse(e.slice(r,o+1));return Array.isArray(s)&&s.length>0?s:null}catch{return null}}async function q(e){const a=await(await fetch(`https://www.youtube.com/watch?v=${e}`,{credentials:"include"})).text(),r=W(a);if(!r)throw new Error("No captions found for this video. It may not have a transcript.");if(r.length===0)throw new Error("No caption tracks available for this video.");const o=(r.find(l=>l.languageCode==="en"&&!l.kind)??r.find(l=>l.languageCode==="en")??r[0]).baseUrl+"&fmt=json3",s=await fetch(o);if(!s.ok)throw new Error("Failed to fetch transcript data.");const d=await s.json(),f=[];for(const l of d.events){if(!l.segs)continue;const b=l.segs.map(F=>F.utf8).join("").replace(/\n/g," ").trim();b&&f.push({text:b,start:l.tStartMs/1e3,duration:l.dDurationMs/1e3})}return f}function K(e,t=80){const a=[];let r="",i=0,o=0;for(const s of e)r.split(/\s+/).filter(Boolean).length>=t&&r.length>0?(a.push({text:r.trim(),start:i,duration:o}),r=s.text,i=s.start,o=s.duration):(r||(i=s.start,o=0),r+=(r?" ":"")+s.text,o=s.start+s.duration-i);return r.trim()&&a.push({text:r.trim(),start:i,duration:o}),a}function I(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),r=Math.floor(e%60);return t>0?`${t}:${String(a).padStart(2,"0")}:${String(r).padStart(2,"0")}`:`${a}:${String(r).padStart(2,"0")}`}function U(e){const t=e.match(/[?&]v=([^&]+)/);return t?t[1]:null}let k=null;async function Y(){if(k)return k;const{pipeline:e}=await N(async()=>{const{pipeline:t}=await import("./transformers.web-DFIKh8Jl.js");return{pipeline:t}},[]);return k=await e("feature-extraction","Xenova/all-MiniLM-L6-v2",{device:"webgpu"}),k}function V(e,t){let a=0,r=0,i=0;for(let o=0;o<e.length;o++)a+=e[o]*t[o],r+=e[o]*e[o],i+=t[o]*t[o];return a/(Math.sqrt(r)*Math.sqrt(i))}async function B(e){const r=(await(await Y())(e,{pooling:"mean",normalize:!0}))[0];return Array.from(r.data)}async function G(e,t){const a=[];for(let r=0;r<e.length;r++){const i=e[r],o=await B(i.text);a.push({...i,embedding:o,index:r}),t==null||t(Math.round((r+1)/e.length*100))}return a}function J(e,t,a=5){const r=t.map(i=>({segment:i,score:V(e,i.embedding)}));return r.sort((i,o)=>o.score-i.score),r.slice(0,a)}function $(e,t){if(!e.trim())return[];const a=e.toLowerCase().trim(),r=[];for(let i=0;i<t.length;i++){const o=t[i];o.text.toLowerCase().includes(a)&&r.push({segment:o,index:i,score:1,matchType:"exact"})}return r}async function Q(e,t,a=8){if(!e.trim())return[];const r=$(e,t),i=new Set(r.map(f=>f.index)),o=await B(e),s=J(o,t,a),d=[...r];for(const{segment:f,score:l}of s)!i.has(f.index)&&l>.3&&d.push({segment:f,index:f.index,score:l,matchType:"semantic"});return d.sort((f,l)=>f.matchType==="exact"&&l.matchType!=="exact"?-1:l.matchType==="exact"&&f.matchType!=="exact"?1:l.score-f.score),d}function X(e,t){if(!t.trim())return e;const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return e.replace(new RegExp(`(${a})`,"gi"),"<mark>$1</mark>")}function Z({segments:e,semanticEnabled:t}){const[a,r]=u.useState(""),[i,o]=u.useState([]),[s,d]=u.useState(!1),f=u.useRef(null),l=u.useCallback(async x=>{if(!x.trim()){o([]);return}d(!0);try{const h=t?await Q(x,e):$(x,e).map(S=>({...S}));o(h)}finally{d(!1)}},[e,t]);function b(x){const h=x.target.value;r(h),f.current&&clearTimeout(f.current),f.current=setTimeout(()=>l(h),400)}function F(x){const h=document.querySelector("video");h&&(h.currentTime=x,h.play())}return n.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[n.jsxs("div",{style:{padding:"12px 16px",borderBottom:"1px solid #3F3F3F"},children:[n.jsxs("div",{style:{position:"relative"},children:[n.jsx("input",{type:"text",value:a,onChange:b,placeholder:t?"Search by meaning or keyword…":"Search transcript…",style:{width:"100%",background:"#212121",border:"1px solid #3F3F3F",borderRadius:6,padding:"9px 36px 9px 12px",color:"#F1F1F1",fontSize:13,outline:"none"},onFocus:x=>x.target.style.borderColor="#FF0000",onBlur:x=>x.target.style.borderColor="#3F3F3F"}),s&&n.jsx("div",{style:{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",width:14,height:14,border:"2px solid #3F3F3F",borderTopColor:"#FF0000",borderRadius:"50%",animation:"spin 0.6s linear infinite"}})]}),t&&n.jsx("p",{style:{marginTop:6,fontSize:11,color:"#AAAAAA"},children:"AI semantic search active — finds related concepts too"})]}),n.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"8px 0"},children:[a&&!s&&i.length===0&&n.jsx("div",{style:{padding:"16px",color:"#AAAAAA",fontSize:13},children:"No results found."}),i.map((x,h)=>n.jsx(ee,{result:x,query:a,onJump:F},h))]})]})}function ee({result:e,query:t,onJump:a}){const r=X(e.segment.text,t);return n.jsxs("div",{onClick:()=>a(e.segment.start),style:{padding:"10px 16px",cursor:"pointer",borderBottom:"1px solid #1a1a1a",transition:"background 0.1s"},onMouseEnter:i=>i.currentTarget.style.background="#1a1a1a",onMouseLeave:i=>i.currentTarget.style.background="transparent",children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:4},children:[n.jsx("span",{style:{fontSize:11,fontWeight:700,color:"#FF0000",fontVariantNumeric:"tabular-nums"},children:I(e.segment.start)}),e.matchType==="semantic"&&n.jsx("span",{style:{fontSize:10,background:"#1e3a5f",color:"#60a5fa",borderRadius:3,padding:"1px 5px",fontWeight:600},children:"AI match"}),e.matchType==="exact"&&n.jsx("span",{style:{fontSize:10,background:"#1a2a1a",color:"#4ade80",borderRadius:3,padding:"1px 5px",fontWeight:600},children:"exact"})]}),n.jsx("p",{style:{fontSize:13,color:"#F1F1F1",margin:0,lineHeight:1.5},dangerouslySetInnerHTML:{__html:r}})]})}function te({segments:e,settings:t,onSettingsChange:a}){const[r,i]=u.useState([]),[o,s]=u.useState(""),[d,f]=u.useState(!1),[l,b]=u.useState(""),F=u.useRef(null),x=u.useRef(""),h=M.find(c=>c.id===t.selectedProvider),S=t.apiKeys[t.selectedProvider]??"",A=!(h!=null&&h.requiresKey)||S.length>0;u.useEffect(()=>{var c;(c=F.current)==null||c.scrollIntoView({behavior:"smooth"})},[r,d]);function C(){return`You are a helpful assistant answering questions about a YouTube video.
You have access to the full transcript below. When relevant, cite specific timestamps like [1:23] so the user can jump to that moment.

TRANSCRIPT:
${e.map(g=>`[${I(g.start)}] ${g.text}`).join(`
`)}

Rules:
- Answer based on the transcript content
- Cite timestamps for specific claims using the format [MM:SS] or [H:MM:SS]
- If the video doesn't cover the topic, say so clearly
- Be concise and direct`}async function T(){if(!o.trim()||d)return;const c={role:"user",content:o.trim()},g=[...r,c];i(g),s(""),f(!0),b(""),x.current="",i(y=>[...y,{role:"assistant",content:""}]);const v=y=>{y.type==="CHAT_CHUNK"&&(x.current=y.payload.fullText,i(m=>{const w=[...m];return w[w.length-1]={role:"assistant",content:x.current},w}))};chrome.runtime.onMessage.addListener(v);try{const y=await chrome.runtime.sendMessage({type:"CHAT_STREAM",payload:{messages:g.map(m=>({role:m.role,content:m.content})),systemPrompt:C(),provider:t.selectedProvider,model:t.selectedModel,apiKey:S,ollamaBaseUrl:t.ollamaBaseUrl}});y!=null&&y.error&&(b(y.error),i(m=>m.slice(0,-1)))}catch(y){b(y instanceof Error?y.message:"Unknown error"),i(m=>m.slice(0,-1))}finally{chrome.runtime.onMessage.removeListener(v),f(!1)}}function E(c){c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),T())}function p(c){const g=document.querySelector("video");g&&(g.currentTime=c,g.play())}function j(c){return c.split(/(\[\d+:\d{2}(?::\d{2})?\])/g).map((v,y)=>{const m=v.match(/\[(\d+):(\d{2})(?::(\d{2}))?\]/);if(m){const w=m[3]!==void 0?parseInt(m[1]):0,P=m[3]!==void 0?parseInt(m[2]):parseInt(m[1]),D=m[3]!==void 0?parseInt(m[3]):parseInt(m[2]),_=w*3600+P*60+D;return n.jsx("button",{onClick:()=>p(_),style:{background:"#1e1e1e",border:"1px solid #3F3F3F",borderRadius:4,color:"#FF0000",cursor:"pointer",fontSize:12,fontWeight:700,padding:"1px 6px",margin:"0 2px"},children:v},y)}return n.jsx("span",{children:v},y)})}return n.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[n.jsxs("div",{style:{padding:"8px 12px",borderBottom:"1px solid #3F3F3F",display:"flex",gap:6,alignItems:"center"},children:[n.jsx("select",{value:t.selectedProvider,onChange:c=>{const g=M.find(v=>v.id===c.target.value);a({...t,selectedProvider:g.id,selectedModel:g.models[0].id})},style:z,children:M.map(c=>n.jsx("option",{value:c.id,children:c.label},c.id))}),n.jsx("select",{value:t.selectedModel,onChange:c=>a({...t,selectedModel:c.target.value}),style:z,children:((h==null?void 0:h.models)??[]).map(c=>n.jsx("option",{value:c.id,children:c.label},c.id))})]}),!A&&n.jsxs("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"#2a1a00",border:"1px solid #7c4a00",borderRadius:6,fontSize:12,color:"#fbbf24"},children:["No API key set for ",h==null?void 0:h.label,". Add one in the extension settings."]}),n.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"12px",display:"flex",flexDirection:"column",gap:12},children:[r.length===0&&n.jsxs("div",{style:{textAlign:"center",color:"#AAAAAA",fontSize:13,marginTop:24,lineHeight:1.7},children:["Ask anything about this video.",n.jsx("br",{}),n.jsx("span",{style:{fontSize:11},children:"Timestamps in answers are clickable."})]}),r.map((c,g)=>n.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:c.role==="user"?"flex-end":"flex-start"},children:n.jsxs("div",{style:{maxWidth:"85%",padding:"9px 12px",borderRadius:c.role==="user"?"12px 12px 2px 12px":"12px 12px 12px 2px",background:c.role==="user"?"#CC0000":"#212121",fontSize:13,lineHeight:1.6,color:"#F1F1F1"},children:[c.role==="assistant"?j(c.content):c.content,d&&g===r.length-1&&c.role==="assistant"&&!c.content&&n.jsx("span",{style:{color:"#AAAAAA"},children:"▋"})]})},g)),l&&n.jsxs("div",{style:{color:"#f87171",fontSize:12,padding:"4px 0"},children:["Error: ",l]}),n.jsx("div",{ref:F})]}),n.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid #3F3F3F",display:"flex",gap:8,alignItems:"flex-end"},children:[n.jsx("textarea",{value:o,onChange:c=>s(c.target.value),onKeyDown:E,placeholder:"Ask about the video… (Enter to send)",disabled:d||!A,rows:1,style:{flex:1,background:"#212121",border:"1px solid #3F3F3F",borderRadius:8,padding:"9px 12px",color:"#F1F1F1",fontSize:13,resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:100,overflow:"auto"},onFocus:c=>c.target.style.borderColor="#FF0000",onBlur:c=>c.target.style.borderColor="#3F3F3F"}),n.jsx("button",{onClick:T,disabled:d||!o.trim()||!A,style:{background:d||!o.trim()||!A?"#3F3F3F":"#FF0000",border:"none",borderRadius:8,color:"white",cursor:d||!o.trim()||!A?"default":"pointer",padding:"9px 14px",fontSize:13,fontWeight:700,transition:"background 0.15s"},children:d?"…":"↑"})]})]})}const z={background:"#212121",border:"1px solid #3F3F3F",borderRadius:5,color:"#F1F1F1",padding:"5px 8px",fontSize:11,cursor:"pointer",flex:1,outline:"none"};function ne({segments:e}){const[t,a]=u.useState(null),r=u.useRef(null);u.useEffect(()=>{const o=document.querySelector("video");if(!o)return;function s(){const d=o.currentTime;let f=0;for(let l=0;l<e.length&&e[l].start<=d;l++)f=l;a(f)}return o.addEventListener("timeupdate",s),()=>o.removeEventListener("timeupdate",s)},[e]),u.useEffect(()=>{var s;if(t===null)return;const o=(s=r.current)==null?void 0:s.querySelector(`[data-index="${t}"]`);o==null||o.scrollIntoView({block:"nearest",behavior:"smooth"})},[t]);function i(o){const s=document.querySelector("video");s&&(s.currentTime=o,s.play())}return n.jsx("div",{ref:r,style:{flex:1,overflowY:"auto",padding:"8px 0"},children:e.map((o,s)=>n.jsxs("div",{"data-index":s,onClick:()=>i(o.start),style:{padding:"8px 16px",cursor:"pointer",background:t===s?"#1a1a1a":"transparent",borderLeft:t===s?"3px solid #FF0000":"3px solid transparent",transition:"all 0.15s"},onMouseEnter:d=>{t!==s&&(d.currentTarget.style.background="#141414")},onMouseLeave:d=>{t!==s&&(d.currentTarget.style.background="transparent")},children:[n.jsx("span",{style:{fontSize:11,fontWeight:700,color:t===s?"#FF0000":"#AAAAAA",fontVariantNumeric:"tabular-nums",display:"block",marginBottom:2},children:I(o.start)}),n.jsx("p",{style:{margin:0,fontSize:13,color:t===s?"#F1F1F1":"#CCCCCC",lineHeight:1.5},children:o.text})]},s))})}function re(){const[e,t]=u.useState(!1),[a,r]=u.useState("search"),[i,o]=u.useState("idle"),[s,d]=u.useState(0),[f,l]=u.useState(""),[b,F]=u.useState([]),[x,h]=u.useState([]),[S,A]=u.useState(O),C=u.useRef(null);u.useEffect(()=>{chrome.runtime.sendMessage({type:"GET_SETTINGS"},p=>{p&&A(p)})},[]),u.useEffect(()=>{if(!e||i!=="idle")return;const p=U(window.location.href);if(!p){l("Could not find a video on this page."),o("error");return}C.current=p,T(p)},[e]);async function T(p){try{o("fetching");const j=await q(p),c=K(j);if(F(c),S.semanticSearchEnabled){o("embedding");const g=await G(c,v=>d(v));h(g)}o("ready")}catch(j){l(j instanceof Error?j.message:"Failed to load transcript."),o("error")}}const E=[{id:"search",label:"Search"},{id:"chat",label:"Chat"},{id:"transcript",label:"Transcript"}];return n.jsxs("div",{style:{pointerEvents:"auto"},children:[n.jsx("button",{onClick:()=>t(p=>!p),style:{position:"fixed",top:"50%",right:e?"380px":"0px",transform:"translateY(-50%)",transition:"right 0.3s ease",zIndex:1e4,background:"#FF0000",color:"white",border:"none",borderRadius:"6px 0 0 6px",padding:"12px 6px",cursor:"pointer",fontSize:"10px",fontWeight:"bold",letterSpacing:"1px",writingMode:"vertical-rl",textOrientation:"mixed"},title:e?"Close transcript panel":"Open transcript search",children:"TRANSCRIPT"}),n.jsxs("div",{style:{position:"fixed",top:0,right:e?0:"-380px",width:"380px",height:"100vh",background:"#0F0F0F",borderLeft:"1px solid #3F3F3F",display:"flex",flexDirection:"column",transition:"right 0.3s ease",zIndex:9999,fontFamily:"'Roboto', 'Arial', sans-serif",color:"#F1F1F1",overflow:"hidden"},children:[n.jsxs("div",{style:{padding:"14px 16px 0",borderBottom:"1px solid #3F3F3F",background:"#0F0F0F"},children:[n.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px"},children:[n.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:"#FF0000",flexShrink:0}}),n.jsx("span",{style:{fontWeight:700,fontSize:14},children:"Transcript Search"}),n.jsxs("span",{style:{marginLeft:"auto",fontSize:11,color:"#AAAAAA"},children:[i==="ready"&&`${b.length} chunks`,i==="embedding"&&`Embedding… ${s}%`,i==="fetching"&&"Fetching…"]}),n.jsx("button",{onClick:()=>t(!1),title:"Close",style:{marginLeft:8,background:"transparent",border:"none",color:"#AAAAAA",cursor:"pointer",fontSize:18,lineHeight:1,padding:"0 2px",flexShrink:0},onMouseEnter:p=>p.currentTarget.style.color="#F1F1F1",onMouseLeave:p=>p.currentTarget.style.color="#AAAAAA",children:"×"})]}),n.jsx("div",{style:{display:"flex",gap:2},children:E.map(p=>n.jsx("button",{onClick:()=>r(p.id),style:{flex:1,padding:"8px 0",background:"transparent",border:"none",borderBottom:a===p.id?"2px solid #FF0000":"2px solid transparent",color:a===p.id?"#F1F1F1":"#AAAAAA",cursor:"pointer",fontSize:13,fontWeight:a===p.id?600:400,transition:"all 0.15s"},children:p.label},p.id))})]}),n.jsxs("div",{style:{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"},children:[i==="error"&&n.jsx("div",{style:{padding:16,color:"#f87171",fontSize:13},children:f}),(i==="fetching"||i==="embedding")&&n.jsxs("div",{style:{padding:24,textAlign:"center",color:"#AAAAAA",fontSize:13},children:[n.jsx("div",{style:{marginBottom:8},children:i==="fetching"?"Fetching transcript…":`Building search index… ${s}%`}),n.jsx("div",{style:{height:3,background:"#3F3F3F",borderRadius:2,overflow:"hidden"},children:n.jsx("div",{style:{height:"100%",background:"#FF0000",width:i==="fetching"?"30%":`${s}%`,transition:"width 0.3s"}})})]}),i==="ready"&&n.jsxs(n.Fragment,{children:[a==="search"&&n.jsx(Z,{segments:x.length>0?x:b.map((p,j)=>({...p,embedding:[],index:j})),semanticEnabled:S.semanticSearchEnabled&&x.length>0}),a==="chat"&&n.jsx(te,{segments:b,settings:S,onSettingsChange:A}),a==="transcript"&&n.jsx(ne,{segments:b})]}),i==="idle"&&n.jsx("div",{style:{padding:24,color:"#AAAAAA",fontSize:13},children:"Opening panel…"})]})]})]})}function R(){if(document.getElementById("yt-transcript-root"))return;const e=document.createElement("div");e.id="yt-transcript-root",e.style.cssText=`
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    z-index: 9999;
    pointer-events: none;
  `,document.body.appendChild(e);const t=e.attachShadow({mode:"open"}),a=document.createElement("div");t.appendChild(a),H(a).render(n.jsx(re,{}))}function L(){const e=new MutationObserver(()=>{document.querySelector("#player")&&(e.disconnect(),R())});e.observe(document.body,{childList:!0,subtree:!0}),document.querySelector("#player")&&R()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",L):L();document.addEventListener("yt-navigate-finish",()=>{const e=document.getElementById("yt-transcript-root");e&&e.remove(),setTimeout(R,500)});
