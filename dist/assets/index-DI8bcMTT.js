import{a5 as T,M as k,R as C,P as J,z as M,a1 as Y,U,c as W,V as P,_ as D,a6 as G,G as V,s as z,o as N,a as p,a4 as S,q as y,b as A,r as K,l as L,$ as Z}from"./types-B0luv8fm.js";var F={},R={};(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Allow=e.ALL=e.COLLECTION=e.ATOM=e.SPECIAL=e.INF=e._INFINITY=e.INFINITY=e.NAN=e.BOOL=e.NULL=e.OBJ=e.ARR=e.NUM=e.STR=void 0,e.STR=1,e.NUM=2,e.ARR=4,e.OBJ=8,e.NULL=16,e.BOOL=32,e.NAN=64,e.INFINITY=128,e._INFINITY=256,e.INF=e.INFINITY|e._INFINITY,e.SPECIAL=e.NULL|e.BOOL|e.INF|e.NAN,e.ATOM=e.STR|e.NUM|e.SPECIAL,e.COLLECTION=e.ARR|e.OBJ,e.ALL=e.ATOM|e.COLLECTION,e.Allow={STR:e.STR,NUM:e.NUM,ARR:e.ARR,OBJ:e.OBJ,NULL:e.NULL,BOOL:e.BOOL,NAN:e.NAN,INFINITY:e.INFINITY,_INFINITY:e._INFINITY,INF:e.INF,SPECIAL:e.SPECIAL,ATOM:e.ATOM,COLLECTION:e.COLLECTION,ALL:e.ALL},e.default=e.Allow})(R);(function(e){var s=T&&T.__createBinding||(Object.create?function(a,c,i,t){t===void 0&&(t=i);var u=Object.getOwnPropertyDescriptor(c,i);(!u||("get"in u?!c.__esModule:u.writable||u.configurable))&&(u={enumerable:!0,get:function(){return c[i]}}),Object.defineProperty(a,t,u)}:function(a,c,i,t){t===void 0&&(t=i),a[t]=c[i]}),r=T&&T.__exportStar||function(a,c){for(var i in a)i!=="default"&&!Object.prototype.hasOwnProperty.call(c,i)&&s(c,a,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.Allow=e.MalformedJSON=e.PartialJSON=e.parseJSON=e.parse=void 0;const n=R;Object.defineProperty(e,"Allow",{enumerable:!0,get:function(){return n.Allow}}),r(R,e);class o extends Error{}e.PartialJSON=o;class l extends Error{}e.MalformedJSON=l;function f(a,c=n.Allow.ALL){if(typeof a!="string")throw new TypeError(`expecting str, got ${typeof a}`);if(!a.trim())throw new Error(`${a} is empty`);return d(a.trim(),c)}e.parseJSON=f;const d=(a,c)=>{const i=a.length;let t=0;const u=h=>{throw new o(`${h} at position ${t}`)},g=h=>{throw new l(`${h} at position ${t}`)},m=()=>(v(),t>=i&&u("Unexpected end of input"),a[t]==='"'?w():a[t]==="{"?B():a[t]==="["?q():a.substring(t,t+4)==="null"||n.Allow.NULL&c&&i-t<4&&"null".startsWith(a.substring(t))?(t+=4,null):a.substring(t,t+4)==="true"||n.Allow.BOOL&c&&i-t<4&&"true".startsWith(a.substring(t))?(t+=4,!0):a.substring(t,t+5)==="false"||n.Allow.BOOL&c&&i-t<5&&"false".startsWith(a.substring(t))?(t+=5,!1):a.substring(t,t+8)==="Infinity"||n.Allow.INFINITY&c&&i-t<8&&"Infinity".startsWith(a.substring(t))?(t+=8,1/0):a.substring(t,t+9)==="-Infinity"||n.Allow._INFINITY&c&&1<i-t&&i-t<9&&"-Infinity".startsWith(a.substring(t))?(t+=9,-1/0):a.substring(t,t+3)==="NaN"||n.Allow.NAN&c&&i-t<3&&"NaN".startsWith(a.substring(t))?(t+=3,NaN):H()),w=()=>{const h=t;let b=!1;for(t++;t<i&&(a[t]!=='"'||b&&a[t-1]==="\\");)b=a[t]==="\\"?!b:!1,t++;if(a.charAt(t)=='"')try{return JSON.parse(a.substring(h,++t-Number(b)))}catch(O){g(String(O))}else if(n.Allow.STR&c)try{return JSON.parse(a.substring(h,t-Number(b))+'"')}catch{return JSON.parse(a.substring(h,a.lastIndexOf("\\"))+'"')}u("Unterminated string literal")},B=()=>{t++,v();const h={};try{for(;a[t]!=="}";){if(v(),t>=i&&n.Allow.OBJ&c)return h;const b=w();v(),t++;try{const O=m();h[b]=O}catch(O){if(n.Allow.OBJ&c)return h;throw O}v(),a[t]===","&&t++}}catch{if(n.Allow.OBJ&c)return h;u("Expected '}' at end of object")}return t++,h},q=()=>{t++;const h=[];try{for(;a[t]!=="]";)h.push(m()),v(),a[t]===","&&t++}catch{if(n.Allow.ARR&c)return h;u("Expected ']' at end of array")}return t++,h},H=()=>{if(t===0){a==="-"&&g("Not sure what '-' is");try{return JSON.parse(a)}catch(b){if(n.Allow.NUM&c)try{return JSON.parse(a.substring(0,a.lastIndexOf("e")))}catch{}g(String(b))}}const h=t;for(a[t]==="-"&&t++;a[t]&&",]}".indexOf(a[t])===-1;)t++;t==i&&!(n.Allow.NUM&c)&&u("Unterminated number literal");try{return JSON.parse(a.substring(h,t))}catch{a.substring(h,t)==="-"&&u("Not sure what '-' is");try{return JSON.parse(a.substring(h,a.lastIndexOf("e")))}catch(O){g(String(O))}}},v=()=>{for(;t<i&&` 
\r	`.includes(a[t]);)t++};return m()},_=f;e.parse=_})(F);function I(e){const s=[];for(const{content:r,role:n}of e)switch(n){case"system":{s.push({content:r,role:"system"});break}case"user":{s.push({...r.reduce((o,l)=>{if(l.type==="text")o.content+=l.text;else{if(l.type==="image"&&l.image instanceof URL)throw new U({functionality:"Image URLs in user messages"});l.type==="image"&&l.image instanceof Uint8Array&&(o.images=o.images||[],o.images.push(W(l.image)))}return o},{content:""}),role:"user"});break}case"assistant":{const o=[],l=[];for(const f of r)switch(f.type){case"text":{o.push(f.text);break}case"tool-call":{l.push({function:{arguments:f.args,name:f.toolName},id:f.toolCallId,type:"function"});break}default:{const d=f;throw new Error(`Unsupported part: ${d}`)}}s.push({content:o.join(","),role:"assistant",tool_calls:l.length>0?l:void 0});break}case"tool":{s.push(...r.map(o=>({content:typeof o.result=="object"?JSON.stringify(o.result):`${o.result}`,role:"tool",tool_call_id:o.toolCallId})));break}default:{const o=n;throw new Error(`Unsupported role: ${o}`)}}return s}var Q=class{constructor({tools:e,type:s}){this._firstMessage=!0,this._tools=e,this._toolPartial="",this._toolCalls=[],this._type=s,this._detectedToolCall=!1}get toolCalls(){return this._toolCalls}get detectedToolCall(){return this._detectedToolCall}parse({controller:e,delta:s}){var r;if(this.detectToolCall(s),!this._detectedToolCall)return!1;this._toolPartial+=s;let n=F.parse(this._toolPartial);Array.isArray(n)||(n=[n]);for(const[o,l]of n.entries()){const f=(r=JSON.stringify(l==null?void 0:l.parameters))!=null?r:"";if(f==="")continue;this._toolCalls[o]||(this._toolCalls[o]={function:{arguments:"",name:l.name},id:M(),type:"function"});const d=this._toolCalls[o];d.function.arguments=f,e.enqueue({argsTextDelta:s,toolCallId:d.id,toolCallType:"function",toolName:d.function.name,type:"tool-call-delta"})}return!0}finish({controller:e}){for(const s of this.toolCalls)e.enqueue({args:s.function.arguments,toolCallId:s.id,toolCallType:"function",toolName:s.function.name,type:"tool-call"});return this.finishReason()}detectToolCall(e){!this._tools||this._tools.length===0||this._firstMessage&&(this._type==="object-tool"?this._detectedToolCall=!0:this._type==="regular"&&(e.trim().startsWith("{")||e.trim().startsWith("["))&&(this._detectedToolCall=!0),this._firstMessage=!1)}finishReason(){return this.detectedToolCall?this._type==="object-tool"?"stop":"tool-calls":"stop"}};function X({finishReason:e,hasToolCalls:s}){switch(e){case"stop":return s?"tool-calls":"stop";default:return"other"}}var j=N({error:N({code:p().nullable(),message:p(),param:S().nullable(),type:p()})}),E=D({errorSchema:j,errorToMessage:e=>e.error.message});function x({mode:e}){var s;const r=(s=e.tools)!=null&&s.length?e.tools:void 0,n=[],o=e.toolChoice;if(r===void 0)return{tools:void 0,toolWarnings:n};const l=[];for(const d of r)d.type==="provider-defined"?n.push({tool:d,type:"unsupported-tool"}):l.push({function:{description:d.description,name:d.name,parameters:d.parameters},type:"function"});if(o===void 0)return{tools:l,toolWarnings:n};const f=o.type;switch(f){case"auto":return{tools:l,toolWarnings:n};case"none":return{tools:void 0,toolWarnings:n};default:{const d=f;throw new U({functionality:`Unsupported tool choice type: ${d}`})}}}function $(e){return Object.fromEntries(Object.entries(e).filter(([,s])=>s!==void 0))}var ee=class extends TransformStream{constructor(){super({flush:e=>{this.buffer.length!==0&&e.enqueue(this.buffer)},transform:(e,s)=>{for(e=this.buffer+e;;){const r=e.indexOf(`
`);if(r===-1)break;s.enqueue(e.slice(0,r)),e=e.slice(r+1)}this.buffer=e}}),this.buffer=""}},te=e=>async({response:s})=>{const r=G(s);if(s.body===null)throw new V({});return{responseHeaders:r,value:s.body.pipeThrough(new TextDecoderStream).pipeThrough(new ee).pipeThrough(new TransformStream({transform(n,o){o.enqueue(z({schema:e,text:n}))}}))}},ae=class{constructor(e,s,r){this.modelId=e,this.settings=s,this.config=r,this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1}get supportsStructuredOutputs(){var e;return(e=this.settings.structuredOutputs)!=null?e:!1}get provider(){return this.config.provider}getArguments({frequencyPenalty:e,maxTokens:s,mode:r,presencePenalty:n,prompt:o,responseFormat:l,seed:f,stopSequences:d,temperature:_,topK:a,topP:c}){const i=r.type,t=[];l!==void 0&&l.type==="json"&&l.schema!==void 0&&!this.supportsStructuredOutputs&&t.push({details:"JSON response format schema is only supported with structuredOutputs",setting:"responseFormat",type:"unsupported-setting"});const u={format:l==null?void 0:l.type,model:this.modelId,options:$({f16_kv:this.settings.f16Kv,frequency_penalty:e,low_vram:this.settings.lowVram,main_gpu:this.settings.mainGpu,min_p:this.settings.minP,mirostat:this.settings.mirostat,mirostat_eta:this.settings.mirostatEta,mirostat_tau:this.settings.mirostatTau,num_batch:this.settings.numBatch,num_ctx:this.settings.numCtx,num_gpu:this.settings.numGpu,num_keep:this.settings.numKeep,num_predict:s,num_thread:this.settings.numThread,numa:this.settings.numa,penalize_newline:this.settings.penalizeNewline,presence_penalty:n,repeat_last_n:this.settings.repeatLastN,repeat_penalty:this.settings.repeatPenalty,seed:f,stop:d,temperature:_,tfs_z:this.settings.tfsZ,top_k:a,top_p:c,typical_p:this.settings.typicalP,use_mlock:this.settings.useMlock,use_mmap:this.settings.useMmap,vocab_only:this.settings.vocabOnly})};switch(i){case"regular":{const{tools:g,toolWarnings:m}=x({mode:r});return{args:{...u,messages:I(o),tools:g},type:i,warnings:[...t,...m]}}case"object-json":return{args:{...u,format:this.supportsStructuredOutputs&&r.schema!==void 0?r.schema:"json",messages:I(o)},type:i,warnings:t};case"object-tool":return{args:{...u,messages:I(o),tool_choice:{function:{name:r.tool.name},type:"function"},tools:[{function:{description:r.tool.description,name:r.tool.name,parameters:r.tool.parameters},type:"function"}]},type:i,warnings:t};default:{const g=i;throw new Error(`Unsupported type: ${g}`)}}}async doGenerate(e){var s,r;const{args:n,warnings:o}=this.getArguments(e),l={...n,stream:!1},{responseHeaders:f,value:d}=await C({abortSignal:e.abortSignal,body:l,failedResponseHandler:E,fetch:this.config.fetch,headers:J(this.config.headers(),e.headers),successfulResponseHandler:P(se),url:`${this.config.baseURL}/chat`}),{messages:_,...a}=l,c=(s=d.message.tool_calls)==null?void 0:s.map(i=>{var t;return{args:JSON.stringify(i.function.arguments),toolCallId:(t=i.id)!=null?t:M(),toolCallType:"function",toolName:i.function.name}});return{finishReason:X({finishReason:d.done_reason,hasToolCalls:c!==void 0&&c.length>0}),rawCall:{rawPrompt:_,rawSettings:a},rawResponse:{headers:f},request:{body:JSON.stringify(l)},text:(r=d.message.content)!=null?r:void 0,toolCalls:c,usage:{completionTokens:d.eval_count||0,promptTokens:d.prompt_eval_count||0},warnings:o}}async doStream(e){if(this.settings.simulateStreaming){const u=await this.doGenerate(e),g=new ReadableStream({start(m){if(m.enqueue({type:"response-metadata",...u.response}),u.text&&m.enqueue({textDelta:u.text,type:"text-delta"}),u.toolCalls)for(const w of u.toolCalls)m.enqueue({argsTextDelta:w.args,toolCallId:w.toolCallId,toolCallType:"function",toolName:w.toolName,type:"tool-call-delta"}),m.enqueue({type:"tool-call",...w});m.enqueue({finishReason:u.finishReason,logprobs:u.logprobs,providerMetadata:u.providerMetadata,type:"finish",usage:u.usage}),m.close()}});return{rawCall:u.rawCall,rawResponse:u.rawResponse,stream:g,warnings:u.warnings}}const{args:s,type:r,warnings:n}=this.getArguments(e),{responseHeaders:o,value:l}=await C({abortSignal:e.abortSignal,body:s,failedResponseHandler:E,fetch:this.config.fetch,headers:J(this.config.headers(),e.headers),successfulResponseHandler:te(ne),url:`${this.config.baseURL}/chat`}),{messages:f,...d}=s,_=e.mode.type==="regular"?e.mode.tools:e.mode.type==="object-tool"?[e.mode.tool]:void 0,a=new Q({tools:_,type:r});let c="other",i={completionTokens:Number.NaN,promptTokens:Number.NaN};const{experimentalStreamTools:t=!0}=this.settings;return{rawCall:{rawPrompt:f,rawSettings:d},rawResponse:{headers:o},request:{body:JSON.stringify(s)},stream:l.pipeThrough(new TransformStream({async flush(u){u.enqueue({finishReason:c,type:"finish",usage:i})},async transform(u,g){if(!u.success){g.enqueue({error:u.error,type:"error"});return}const m=u.value;if(m.done){c=a.finish({controller:g}),i={completionTokens:m.eval_count,promptTokens:m.prompt_eval_count||0};return}t&&a.parse({controller:g,delta:m.message.content})||m.message.content!==null&&g.enqueue({textDelta:m.message.content,type:"text-delta"})}})),warnings:n}}},se=N({created_at:p(),done:L(!0),done_reason:p().optional().nullable(),eval_count:y(),eval_duration:y(),load_duration:y().optional(),message:N({content:p(),role:p(),tool_calls:A(N({function:N({arguments:K(S()),name:p()}),id:p().optional()})).optional().nullable()}),model:p(),prompt_eval_count:y().optional(),prompt_eval_duration:y().optional(),total_duration:y()}),ne=Z("done",[N({created_at:p(),done:L(!1),message:N({content:p(),role:p()}),model:p()}),N({created_at:p(),done:L(!0),eval_count:y(),eval_duration:y(),load_duration:y().optional(),model:p(),prompt_eval_count:y().optional(),prompt_eval_duration:y().optional(),total_duration:y()})]),re=class{constructor(e,s,r){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=r}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:2048}get supportsParallelCalls(){return!1}async doEmbed({abortSignal:e,values:s}){if(s.length>this.maxEmbeddingsPerCall)throw new Y({maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,modelId:this.modelId,provider:this.provider,values:s});const{responseHeaders:r,value:n}=await C({abortSignal:e,body:{input:s,model:this.modelId},failedResponseHandler:E,fetch:this.config.fetch,headers:this.config.headers(),successfulResponseHandler:P(oe),url:`${this.config.baseURL}/embed`});return{embeddings:n.embeddings,rawResponse:{headers:r},usage:n.prompt_eval_count?{tokens:n.prompt_eval_count}:void 0}}},oe=N({embeddings:A(A(y())),prompt_eval_count:y().nullable()});function le(e={}){var s;const r=(s=k(e.baseURL))!=null?s:"http://127.0.0.1:11434/api",n=()=>({...e.headers}),o=(d,_={})=>new ae(d,_,{baseURL:r,fetch:e.fetch,headers:n,provider:"ollama.chat"}),l=(d,_={})=>new re(d,_,{baseURL:r,fetch:e.fetch,headers:n,provider:"ollama.embedding"}),f=function(d,_){if(new.target)throw new Error("The Ollama model function cannot be called with the new keyword.");return o(d,_)};return f.chat=o,f.embedding=l,f.languageModel=o,f.textEmbedding=l,f.textEmbeddingModel=l,f}var ue=le();export{le as createOllama,ue as ollama};
