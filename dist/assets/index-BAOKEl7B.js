import{M as H,R as k,P as T,a1 as L,S as q,V as j,W as $,U as R,c as A,_ as J,o as c,a as l,l as C,u as E,b as w,$ as O,q as y,Y as V}from"./types-B0luv8fm.js";function D(e){const s=[];for(let n=0;n<e.length;n++){const{role:r,content:a}=e[n],i=n===e.length-1;switch(r){case"system":{s.push({role:"system",content:a});break}case"user":{s.push({role:"user",content:a.map(t=>{var o;switch(t.type){case"text":return{type:"text",text:t.text};case"image":return{type:"image_url",image_url:t.image instanceof URL?t.image.toString():`data:${(o=t.mimeType)!=null?o:"image/jpeg"};base64,${A(t.image)}`};case"file":{if(!(t.data instanceof URL))throw new R({functionality:"File content parts in user messages"});switch(t.mimeType){case"application/pdf":return{type:"document_url",document_url:t.data.toString()};default:throw new R({functionality:"Only PDF files are supported in user messages"})}}}})});break}case"assistant":{let t="";const o=[];for(const u of a)switch(u.type){case"text":{t+=u.text;break}case"tool-call":{o.push({id:u.toolCallId,type:"function",function:{name:u.toolName,arguments:JSON.stringify(u.args)}});break}}s.push({role:"assistant",content:t,prefix:i?!0:void 0,tool_calls:o.length>0?o:void 0});break}case"tool":{for(const t of a)s.push({role:"tool",name:t.toolName,content:JSON.stringify(t.result),tool_call_id:t.toolCallId});break}default:{const t=r;throw new Error(`Unsupported role: ${t}`)}}}return s}function M(e){switch(e){case"stop":return"stop";case"length":case"model_length":return"length";case"tool_calls":return"tool-calls";default:return"unknown"}}var K=c({object:C("error"),message:l(),type:l(),param:l().nullable(),code:l().nullable()}),S=J({errorSchema:K,errorToMessage:e=>e.message});function N({id:e,model:s,created:n}){return{id:e??void 0,modelId:s??void 0,timestamp:n!=null?new Date(n*1e3):void 0}}function W(e){var s;const n=(s=e.tools)!=null&&s.length?e.tools:void 0,r=[];if(n==null)return{tools:void 0,tool_choice:void 0,toolWarnings:r};const a=[];for(const o of n)o.type==="provider-defined"?r.push({type:"unsupported-tool",tool:o}):a.push({type:"function",function:{name:o.name,description:o.description,parameters:o.parameters}});const i=e.toolChoice;if(i==null)return{tools:a,tool_choice:void 0,toolWarnings:r};const t=i.type;switch(t){case"auto":case"none":return{tools:a,tool_choice:t,toolWarnings:r};case"required":return{tools:a,tool_choice:"any",toolWarnings:r};case"tool":return{tools:a.filter(o=>o.function.name===i.toolName),tool_choice:"any",toolWarnings:r};default:{const o=t;throw new R({functionality:`Unsupported tool choice type: ${o}`})}}}var F=class{constructor(e,s,n){this.specificationVersion="v1",this.defaultObjectGenerationMode="json",this.supportsImageUrls=!1,this.modelId=e,this.settings=s,this.config=n}get provider(){return this.config.provider}supportsUrl(e){return e.protocol==="https:"}getArgs({mode:e,prompt:s,maxTokens:n,temperature:r,topP:a,topK:i,frequencyPenalty:t,presencePenalty:o,stopSequences:u,responseFormat:p,seed:f,providerMetadata:h}){var m,b;const v=e.type,d=[];i!=null&&d.push({type:"unsupported-setting",setting:"topK"}),t!=null&&d.push({type:"unsupported-setting",setting:"frequencyPenalty"}),o!=null&&d.push({type:"unsupported-setting",setting:"presencePenalty"}),u!=null&&d.push({type:"unsupported-setting",setting:"stopSequences"}),p!=null&&p.type==="json"&&p.schema!=null&&d.push({type:"unsupported-setting",setting:"responseFormat",details:"JSON response format schema is not supported"});const x={model:this.modelId,safe_prompt:this.settings.safePrompt,max_tokens:n,temperature:r,top_p:a,random_seed:f,response_format:(p==null?void 0:p.type)==="json"?{type:"json_object"}:void 0,document_image_limit:(m=h==null?void 0:h.mistral)==null?void 0:m.documentImageLimit,document_page_limit:(b=h==null?void 0:h.mistral)==null?void 0:b.documentPageLimit,messages:D(s)};switch(v){case"regular":{const{tools:_,tool_choice:g,toolWarnings:P}=W(e);return{args:{...x,tools:_,tool_choice:g},warnings:[...d,...P]}}case"object-json":return{args:{...x,response_format:{type:"json_object"}},warnings:d};case"object-tool":return{args:{...x,tool_choice:"any",tools:[{type:"function",function:e.tool}]},warnings:d};default:{const _=v;throw new Error(`Unsupported type: ${_}`)}}}async doGenerate(e){var s;const{args:n,warnings:r}=this.getArgs(e),{responseHeaders:a,value:i,rawValue:t}=await k({url:`${this.config.baseURL}/chat/completions`,headers:T(this.config.headers(),e.headers),body:n,failedResponseHandler:S,successfulResponseHandler:j(B),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:o,...u}=n,p=i.choices[0];let f=U(p.message.content);const h=o[o.length-1];return h.role==="assistant"&&(f!=null&&f.startsWith(h.content))&&(f=f.slice(h.content.length)),{text:f,toolCalls:(s=p.message.tool_calls)==null?void 0:s.map(m=>({toolCallType:"function",toolCallId:m.id,toolName:m.function.name,args:m.function.arguments})),finishReason:M(p.finish_reason),usage:{promptTokens:i.usage.prompt_tokens,completionTokens:i.usage.completion_tokens},rawCall:{rawPrompt:o,rawSettings:u},rawResponse:{headers:a,body:t},request:{body:JSON.stringify(n)},response:N(i),warnings:r}}async doStream(e){const{args:s,warnings:n}=this.getArgs(e),r={...s,stream:!0},{responseHeaders:a,value:i}=await k({url:`${this.config.baseURL}/chat/completions`,headers:T(this.config.headers(),e.headers),body:r,failedResponseHandler:S,successfulResponseHandler:$(G),abortSignal:e.abortSignal,fetch:this.config.fetch}),{messages:t,...o}=s;let u="unknown",p={promptTokens:Number.NaN,completionTokens:Number.NaN},f=0,h=!1;return{stream:i.pipeThrough(new TransformStream({transform(m,b){if(!m.success){b.enqueue({type:"error",error:m.error});return}f++;const v=m.value;f===1&&b.enqueue({type:"response-metadata",...N(v)}),v.usage!=null&&(p={promptTokens:v.usage.prompt_tokens,completionTokens:v.usage.completion_tokens});const d=v.choices[0];if((d==null?void 0:d.finish_reason)!=null&&(u=M(d.finish_reason)),(d==null?void 0:d.delta)==null)return;const x=d.delta,_=U(x.content);if(f<=2){const g=t[t.length-1];if(g.role==="assistant"&&_===g.content.trimEnd()){_.length<g.content.length&&(h=!0);return}}if(_!=null&&(b.enqueue({type:"text-delta",textDelta:h?_.trimStart():_}),h=!1),x.tool_calls!=null)for(const g of x.tool_calls)b.enqueue({type:"tool-call-delta",toolCallType:"function",toolCallId:g.id,toolName:g.function.name,argsTextDelta:g.function.arguments}),b.enqueue({type:"tool-call",toolCallType:"function",toolCallId:g.id,toolName:g.function.name,args:g.function.arguments})},flush(m){m.enqueue({type:"finish",finishReason:u,usage:p})}})),rawCall:{rawPrompt:t,rawSettings:o},rawResponse:{headers:a},request:{body:JSON.stringify(r)},warnings:n}}};function U(e){if(typeof e=="string")return e;if(e==null)return;const s=[];for(const n of e){const{type:r}=n;switch(r){case"text":s.push(n.text);break;case"image_url":case"reference":break;default:{const a=r;throw new Error(`Unsupported type: ${a}`)}}}return s.length?s.join(""):void 0}var I=E([l(),w(O("type",[c({type:C("text"),text:l()}),c({type:C("image_url"),image_url:E([l(),c({url:l(),detail:l().nullable()})])}),c({type:C("reference"),reference_ids:w(y())})]))]).nullish(),B=c({id:l().nullish(),created:y().nullish(),model:l().nullish(),choices:w(c({message:c({role:C("assistant"),content:I,tool_calls:w(c({id:l(),function:c({name:l(),arguments:l()})})).nullish()}),index:y(),finish_reason:l().nullish()})),object:C("chat.completion"),usage:c({prompt_tokens:y(),completion_tokens:y()})}),G=c({id:l().nullish(),created:y().nullish(),model:l().nullish(),choices:w(c({delta:c({role:V(["assistant"]).optional(),content:I,tool_calls:w(c({id:l(),function:c({name:l(),arguments:l()})})).nullish()}),finish_reason:l().nullish(),index:y()})),usage:c({prompt_tokens:y(),completion_tokens:y()}).nullish()}),Y=class{constructor(e,s,n){this.specificationVersion="v1",this.modelId=e,this.settings=s,this.config=n}get provider(){return this.config.provider}get maxEmbeddingsPerCall(){var e;return(e=this.settings.maxEmbeddingsPerCall)!=null?e:32}get supportsParallelCalls(){var e;return(e=this.settings.supportsParallelCalls)!=null?e:!1}async doEmbed({values:e,abortSignal:s,headers:n}){if(e.length>this.maxEmbeddingsPerCall)throw new L({provider:this.provider,modelId:this.modelId,maxEmbeddingsPerCall:this.maxEmbeddingsPerCall,values:e});const{responseHeaders:r,value:a}=await k({url:`${this.config.baseURL}/embeddings`,headers:T(this.config.headers(),n),body:{model:this.modelId,input:e,encoding_format:"float"},failedResponseHandler:S,successfulResponseHandler:j(z),abortSignal:s,fetch:this.config.fetch});return{embeddings:a.data.map(i=>i.embedding),usage:a.usage?{tokens:a.usage.prompt_tokens}:void 0,rawResponse:{headers:r}}}},z=c({data:w(c({embedding:w(y())})),usage:c({prompt_tokens:y()}).nullish()});function Q(e={}){var s;const n=(s=H(e.baseURL))!=null?s:"https://api.mistral.ai/v1",r=()=>({Authorization:`Bearer ${q({apiKey:e.apiKey,environmentVariableName:"MISTRAL_API_KEY",description:"Mistral"})}`,...e.headers}),a=(o,u={})=>new F(o,u,{provider:"mistral.chat",baseURL:n,headers:r,fetch:e.fetch}),i=(o,u={})=>new Y(o,u,{provider:"mistral.embedding",baseURL:n,headers:r,fetch:e.fetch}),t=function(o,u){if(new.target)throw new Error("The Mistral model function cannot be called with the new keyword.");return a(o,u)};return t.languageModel=a,t.chat=a,t.embedding=i,t.textEmbedding=i,t.textEmbeddingModel=i,t}var Z=Q();export{Q as createMistral,Z as mistral};
