import{r as x,j as o,R as re,a as Y,c as le}from"./client-B-OClMmu.js";import{P as U,D as X}from"./providers-B-uW_wjG.js";function de(n){var t;const e=n.split('"captions":');if(e.length<=1)return[];try{const s=e[1].split(',"videoDetails')[0].replace(/\n/g,""),r=JSON.parse(s),a=(t=r==null?void 0:r.playerCaptionsTracklistRenderer)==null?void 0:t.captionTracks;if(Array.isArray(a)&&a.length>0)return a}catch{}return[]}function ue(){var e,t;const n=document.querySelector('script[id="ytInitialPlayerResponse"]');if(n!=null&&n.textContent)try{const s=JSON.parse(n.textContent),r=(t=(e=s==null?void 0:s.captions)==null?void 0:e.playerCaptionsTracklistRenderer)==null?void 0:t.captionTracks;if(Array.isArray(r)&&r.length>0)return r}catch{}for(const s of document.querySelectorAll("script")){const r=s.textContent??"";if(r.includes('"captionTracks"')){const a=de(r);if(a.length>0)return a}}throw new Error("No captions found. This video may not have a transcript.")}async function pe(n){var r,a;const e=await fetch("https://www.youtube.com/youtubei/v1/player?prettyPrint=false",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"ANDROID",clientVersion:"20.10.38"}},videoId:n})});if(!e.ok)throw new Error(`Innertube player returned ${e.status}`);const t=await e.json(),s=(a=(r=t==null?void 0:t.captions)==null?void 0:r.playerCaptionsTracklistRenderer)==null?void 0:a.captionTracks;return Array.isArray(s)?s:[]}async function fe(n){var i,l,c,p,u,g,w,S,$,M;const e={steps:[]};let t=[],s=null;try{t=await pe(n),e.steps.push({label:"Page fetch caption tracks",status:t.length>0?"ok":"warn",detail:t.length>0?`Found ${t.length} track(s): ${t.map(y=>`${y.languageCode}${y.kind?` [${y.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(y){s=y instanceof Error?y.message:String(y),e.steps.push({label:"Page fetch caption tracks",status:"error",detail:s})}if(t.length===0)try{t=ue(),e.steps.push({label:"DOM fallback caption tracks",status:t.length>0?"ok":"warn",detail:t.length>0?`Found ${t.length} track(s): ${t.map(y=>`${y.languageCode}${y.kind?` [${y.kind}]`:""}`).join(", ")}`:"Returned 0 tracks"})}catch(y){const m=y instanceof Error?y.message:String(y);throw e.steps.push({label:"DOM fallback caption tracks",status:"error",detail:m}),Object.assign(new Error(`Could not find any caption tracks.
Background: ${s??"n/a"}
DOM: ${m}`),{diagnostics:e})}if(t.length===0)throw e.steps.push({label:"Select track",status:"error",detail:"No tracks available to select."}),Object.assign(new Error("No caption tracks found in background fetch or DOM."),{diagnostics:e});const r=t.find(y=>y.languageCode==="en"&&!y.kind)??t.find(y=>y.languageCode==="en")??t[0];e.steps.push({label:"Select track",status:"ok",detail:`Using "${((i=r.name)==null?void 0:i.simpleText)??"unknown"}" (lang=${r.languageCode}, kind=${r.kind??"manual"})`});try{const y=new TextEncoder,m=y.encode(n),d=y.encode(r.languageCode),h=btoa(String.fromCharCode(10,m.length,...m,18,d.length,...d)),v=await fetch("https://www.youtube.com/youtubei/v1/get_transcript?prettyPrint=false",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:{client:{clientName:"WEB",clientVersion:"2.20241126.01.00",hl:"en",gl:"US"}},params:h})});if(v.ok){const k=await v.json(),T=((S=(w=(g=(u=(p=(c=(l=k==null?void 0:k.actions)==null?void 0:l[0])==null?void 0:c.updateEngagementPanelAction)==null?void 0:p.content)==null?void 0:u.transcriptRenderer)==null?void 0:g.body)==null?void 0:w.transcriptBodyRenderer)==null?void 0:S.cueGroups)??[],C=[];for(const z of T)for(const P of(($=z==null?void 0:z.transcriptCueGroupRenderer)==null?void 0:$.cues)??[]){const b=P==null?void 0:P.transcriptCueRenderer,f=(((M=b==null?void 0:b.cue)==null?void 0:M.simpleText)??"").trim(),j=parseInt((b==null?void 0:b.startOffsetMs)??"0",10)/1e3,A=parseInt((b==null?void 0:b.durationMs)??"0",10)/1e3;f&&C.push({text:f,start:j,duration:A})}if(C.length>0)return e.steps.push({label:"get_transcript API",status:"ok",detail:`${C.length} cues via Innertube get_transcript`}),{segments:C,tracksLen:t.length,diagnostics:e}}e.steps.push({label:"get_transcript API",status:"warn",detail:`status=${v.status}, no cues — falling back to timedtext`})}catch(y){e.steps.push({label:"get_transcript API",status:"warn",detail:`Error: ${y instanceof Error?y.message:String(y)} — falling back to timedtext`})}let a;try{a=await he(r.baseUrl,e)}catch(y){const m=y instanceof Error?y.message:String(y);throw Object.assign(new Error(m),{diagnostics:e})}return{segments:a,tracksLen:t.length,diagnostics:e}}async function he(n,e){const t=(()=>{try{const a=new URL(n);return a.searchParams.delete("exp"),a.toString()}catch{return n}})();n!==t&&e.steps.push({label:"Stripped exp param",status:"ok",detail:"Removed exp=xpe from timedtext URL to disable POT enforcement."});let s="skipped";try{const a=t+"&fmt=json3",i=await fetch(a,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),l=i.headers.get("content-length")??"unknown",c=await i.text();if(e.steps.push({label:"HTTP response (JSON3)",status:c.length>0?"ok":"error",detail:`status=${i.status}, content-length=${l}, body=${c.length} bytes, preview: ${JSON.stringify(c.slice(0,200))}`}),s=`${c.length} bytes`,c){const p=JSON.parse(c),u=[];for(const g of p.events??[]){if(!g.segs)continue;const w=g.segs.map(S=>S.utf8).join("").replace(/\n/g," ").trim();w&&u.push({text:w,start:g.tStartMs/1e3,duration:g.dDurationMs/1e3})}if(u.length>0)return e.steps.push({label:"Fetch JSON3 transcript",status:"ok",detail:`${u.length} events, ${s}`}),u;s+=" (0 events after filtering)"}else s="empty body"}catch(a){s=`Error: ${a instanceof Error?a.message:String(a)}`}e.steps.push({label:"Fetch JSON3 transcript",status:"warn",detail:s+" — falling back to XML"});let r="skipped";try{const a=await fetch(t,{credentials:"include",headers:{"Accept-Language":"en-US,en;q=0.9"}}),i=a.headers.get("content-length")??"unknown",l=await a.text();e.steps.push({label:"HTTP response (XML)",status:l.length>0?"ok":"error",detail:`status=${a.status}, content-length=${i}, body=${l.length} bytes, preview: ${JSON.stringify(l.slice(0,200))}`}),r=`${l.length} bytes`;const c=ge(l);return e.steps.push({label:"Fetch XML transcript",status:"ok",detail:`${c.length} segments, ${r}`}),c}catch(a){const i=a instanceof Error?a.message:String(a);throw e.steps.push({label:"Fetch XML transcript",status:"error",detail:`${r} — ${i}`}),new Error(i)}}function Q(n){return n.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/\n/g," ").trim()}function ge(n){const e=new DOMParser().parseFromString(n,"text/xml"),t=[],s=e.querySelectorAll("p");if(s.length>0){for(const r of s){const a=parseFloat(r.getAttribute("t")??"0"),i=parseFloat(r.getAttribute("d")??"0"),l=r.querySelectorAll("s"),c=l.length>0?Array.from(l).map(u=>u.textContent??"").join(""):r.textContent??"",p=Q(c);p&&t.push({text:p,start:a/1e3,duration:i/1e3})}if(t.length>0)return t}for(const r of e.querySelectorAll("text")){const a=parseFloat(r.getAttribute("start")??"0"),i=parseFloat(r.getAttribute("dur")??"0"),l=Q(r.textContent??"");l&&t.push({text:l,start:a,duration:i})}if(t.length===0)throw new Error(`XML parsed but yielded 0 segments. XML snippet: ${n.slice(0,300)}`);return t}function ye(n,e=80){const t=[];let s="",r=0,a=0;for(const i of n)s.split(/\s+/).filter(Boolean).length>=e&&s.length>0?(t.push({text:s.trim(),start:r,duration:a}),s=i.text,r=i.start,a=i.duration):(s||(r=i.start,a=0),s+=(s?" ":"")+i.text,a=i.start+i.duration-r);return s.trim()&&t.push({text:s.trim(),start:r,duration:a}),t}function G(n){const e=Math.floor(n/3600),t=Math.floor(n%3600/60),s=Math.floor(n%60);return e>0?`${e}:${String(t).padStart(2,"0")}:${String(s).padStart(2,"0")}`:`${t}:${String(s).padStart(2,"0")}`}function me(n){const e=n.match(/[?&]v=([^&]+)/);return e?e[1]:null}async function se(n){return new Promise((e,t)=>{chrome.runtime.sendMessage({type:"EMBED_TEXT",payload:{text:n}},s=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):!s||s.error?t(new Error((s==null?void 0:s.error)??"No response from background")):e(s.embedding)})})}async function xe(n,e){const t=[];for(let s=0;s<n.length;s++){const r=n[s],a=await se(r.text);t.push({...r,embedding:a,index:s}),e==null||e(Math.round((s+1)/n.length*100))}return t}function be(n,e){if(n.length!==e.length||n.length===0)return 0;let t=0,s=0,r=0;for(let i=0;i<n.length;i++)t+=n[i]*e[i],s+=n[i]*n[i],r+=e[i]*e[i];const a=Math.sqrt(s)*Math.sqrt(r);return a===0?0:Math.max(-1,Math.min(1,t/a))}function ve(n,e,t=5){const s=e.map(r=>({segment:r,score:be(n,r.embedding)}));return s.sort((r,a)=>a.score-r.score),s.slice(0,t)}let ae=[];function Se(n){ae=n}function ke(){return ae}function we(n){const e=n.match(/^\[(\d+):(\d{2})(?::(\d{2}))?\]$/);if(!e)return null;const t=e[3]!==void 0?parseInt(e[1],10):0,s=e[3]!==void 0?parseInt(e[2],10):parseInt(e[1],10),r=e[3]!==void 0?parseInt(e[3],10):parseInt(e[2],10);return t*3600+s*60+r}function D(n,e,t){const s=/(\[\d+:\d{2}(?::\d{2})?\]|\*\*(?:[^*]|\*(?!\*))+?\*\*|\*[^*\n]+?\*|`[^`\n]+`)/g;return n.split(s).map((a,i)=>{const l=`${t}-${i}`,c=we(a);return c!==null?o.jsx("button",{type:"button",onClick:()=>e(c),style:{background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:4,color:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",cursor:"pointer",fontSize:12,fontWeight:700,padding:"1px 6px",margin:"0 2px",fontFamily:"inherit"},children:a},l):a.startsWith("**")&&a.endsWith("**")&&a.length>4?o.jsx("strong",{children:D(a.slice(2,-2),e,`${l}-b`)},l):a.startsWith("*")&&a.endsWith("*")&&a.length>2?o.jsx("em",{children:D(a.slice(1,-1),e,`${l}-i`)},l):a.startsWith("`")&&a.endsWith("`")&&a.length>2?o.jsx("code",{style:{background:"rgba(0,0,0,0.35)",borderRadius:3,padding:"1px 5px",fontSize:"0.88em",fontFamily:"monospace"},children:a.slice(1,-1)},l):o.jsx(re.Fragment,{children:a},l)})}function Te(n,e){const t=[],s=/```(\w*)\n?([\s\S]*?)```/g;let r=0,a;for(;(a=s.exec(n))!==null;)a.index>r&&t.push({t:"text",text:n.slice(r,a.index)}),t.push({t:"code",lang:a[1]||"",code:a[2].replace(/\n$/,"")}),r=a.index+a[0].length;return r<n.length&&t.push({t:"text",text:n.slice(r)}),o.jsx("div",{style:{lineHeight:1.65},children:t.map((i,l)=>{if(i.t==="code")return o.jsx("pre",{style:{background:"rgba(0,0,0,0.45)",borderRadius:6,padding:"8px 10px",overflowX:"auto",fontSize:12,margin:"6px 0",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-all"},children:o.jsx("code",{children:i.code})},l);const c=i.text.split(`
`),p=[];let u=0;for(;u<c.length;){const g=c[u];if(!g.trim()){u++;continue}const w=g.match(/^(#{1,3}) (.+)/);if(w){const S=w[1].length;p.push(o.jsx("div",{style:{fontWeight:700,fontSize:S===1?15:14,margin:"8px 0 3px",color:"var(--yt-spec-text-primary, #f1f1f1)"},children:D(w[2],e,`${l}-h-${u}`)},`${l}-h-${u}`)),u++;continue}if(/^[-*+] /.test(g)){const S=[];for(;u<c.length&&/^[-*+] /.test(c[u]);)S.push(o.jsx("li",{style:{marginBottom:2},children:D(c[u].slice(2),e,`${l}-li-${u}`)},u)),u++;p.push(o.jsx("ul",{style:{paddingLeft:18,margin:"3px 0"},children:S},`${l}-ul-${u}`));continue}if(/^\d+\. /.test(g)){const S=[];for(;u<c.length&&/^\d+\. /.test(c[u]);)S.push(o.jsx("li",{style:{marginBottom:2},children:D(c[u].replace(/^\d+\. /,""),e,`${l}-oli-${u}`)},u)),u++;p.push(o.jsx("ol",{style:{paddingLeft:18,margin:"3px 0"},children:S},`${l}-ol-${u}`));continue}if(g.startsWith("> ")){p.push(o.jsx("blockquote",{style:{borderLeft:"3px solid rgba(255,255,255,0.2)",paddingLeft:8,margin:"4px 0",color:"var(--yt-spec-text-secondary, #aaa)",fontStyle:"italic"},children:D(g.slice(2),e,`${l}-bq-${u}`)},`${l}-bq-${u}`)),u++;continue}if(/^---+$/.test(g.trim())){p.push(o.jsx("hr",{style:{border:"none",borderTop:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",margin:"8px 0"}},`${l}-hr-${u}`)),u++;continue}p.push(o.jsx("p",{style:{margin:"0 0 5px"},children:D(g,e,`${l}-p-${u}`)},`${l}-p-${u}`)),u++}return o.jsx(re.Fragment,{children:p},l)})})}function je({segments:n,settings:e,onSettingsChange:t,videoId:s}){const[r,a]=x.useState([]),[i,l]=x.useState(""),[c,p]=x.useState(!1),[u,g]=x.useState(null),[w,S]=x.useState(""),$=x.useRef(null),M=x.useRef(""),y=U.filter(f=>!f.requiresKey||(e.apiKeys[f.id]??"").length>0),m=y.length>0,d=U.find(f=>f.id===e.selectedProvider),h=e.apiKeys[e.selectedProvider]??"",v=!(d!=null&&d.requiresKey)||h.length>0,k=!!e.selectedModel;x.useEffect(()=>{if(!e.selectedModel&&y.length>0){const f=y[0];t({...e,selectedProvider:f.id,selectedModel:f.models[0].id})}},[y.length,e.selectedModel]),x.useEffect(()=>{if(s)try{const f=sessionStorage.getItem(`yt-transcript-chat:${s}`);f&&a(JSON.parse(f))}catch{}},[s]),x.useEffect(()=>{if(s)try{r.length>0?sessionStorage.setItem(`yt-transcript-chat:${s}`,JSON.stringify(r)):sessionStorage.removeItem(`yt-transcript-chat:${s}`)}catch{}},[r,s]),x.useEffect(()=>{const f=$.current;f&&(f.scrollTop=f.scrollHeight)},[r,c,u]);function T(){a([]),s&&sessionStorage.removeItem(`yt-transcript-chat:${s}`)}function C(){const f=n.length>0?n[n.length-1].start+(n[n.length-1].duration||0):0,j=Math.round(f/60);return`You are a helpful assistant answering questions about a YouTube video based on its transcript.

You have access to a \`search_transcript\` tool that retrieves up to 15 relevant transcript segments for a given query.
ALWAYS use this tool to find relevant context before answering — never answer content questions from memory alone.
You may search up to 3 times using different queries to gather all necessary information.

Video info: ${n.length} transcript segments, approximately ${j} minutes long.

When referencing video content, ALWAYS cite the exact timestamp in [MM:SS] or [H:MM:SS] format — these render as clickable seek buttons in the UI.

Guidelines:
- Search first, answer second — always search before responding to content questions
- Use different search angles if one query isn't enough
- Include a timestamp for every specific claim, quote, or reference from the video
- Be concise and direct`}async function z(){if(!i.trim()||c)return;const f={role:"user",content:i.trim()},j=[...r,f];a(j),l(""),p(!0),S(""),g(null),M.current="",a(E=>[...E,{role:"assistant",content:""}]);const A=E=>{if(E.type==="CHAT_SEARCHING"){g(E.payload.query??null);return}E.type==="CHAT_CHUNK"&&(g(null),M.current=E.payload.fullText??"",a(N=>{const W=[...N];return W[W.length-1]={role:"assistant",content:M.current},W}))};chrome.runtime.onMessage.addListener(A);try{const E=await chrome.runtime.sendMessage({type:"CHAT_STREAM",payload:{messages:j.map(N=>({role:N.role,content:N.content})),systemPrompt:C(),provider:e.selectedProvider,model:e.selectedModel,apiKey:h,ollamaBaseUrl:e.ollamaBaseUrl}});E!=null&&E.error&&(S(E.error),a(N=>N.slice(0,-1)))}catch(E){S(E instanceof Error?E.message:"Unknown error"),a(N=>N.slice(0,-1))}finally{chrome.runtime.onMessage.removeListener(A),p(!1),g(null)}}function P(f){f.key==="Enter"&&!f.shiftKey&&(f.preventDefault(),z())}function b(f){const j=document.querySelector("video");j&&(j.currentTime=f,j.play())}return o.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[(!m||r.length>0)&&o.jsxs("div",{style:{padding:"8px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",alignItems:"center",flexShrink:0},children:[m?o.jsx("div",{style:{flex:1}}):o.jsx("span",{style:{fontSize:12,color:"#fbbf24"},children:"No API provider configured. Add an API key in the extension settings."}),r.length>0&&o.jsx("button",{type:"button",onClick:T,title:"Clear chat history",style:{background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",padding:4,borderRadius:4,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"color 0.15s"},onMouseEnter:f=>f.currentTarget.style.color="var(--yt-spec-text-primary, #f1f1f1)",onMouseLeave:f=>f.currentTarget.style.color="var(--yt-spec-text-secondary, #aaa)",children:o.jsx("svg",{width:"13",height:"13",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",children:o.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})})})]}),!v&&o.jsxs("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(42,26,0,0.8)",border:"1px solid rgba(124,74,0,0.8)",borderRadius:6,fontSize:12,color:"#fbbf24",flexShrink:0},children:["No API key set for ",d==null?void 0:d.label,". Add one in the extension settings."]}),v&&!k&&o.jsx("div",{style:{margin:"8px 12px",padding:"8px 10px",background:"rgba(0,0,0,0.3)",border:"1px solid rgba(255,255,255,0.15)",borderRadius:6,fontSize:12,color:"var(--yt-spec-text-secondary, #aaa)",flexShrink:0},children:"Select a model in the extension settings to use AI Chat."}),o.jsxs("div",{ref:$,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"12px",display:"flex",flexDirection:"column",gap:10},children:[r.length===0&&o.jsxs("div",{style:{textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13,marginTop:16,lineHeight:1.7},children:["Ask anything about this video.",o.jsx("br",{}),o.jsx("span",{style:{fontSize:11},children:"The AI will search the transcript up to 3 times. Timestamps are clickable."})]}),r.map((f,j)=>{const A=c&&j===r.length-1&&f.role==="assistant";return o.jsx("div",{style:{display:"flex",flexDirection:"column",alignItems:f.role==="user"?"flex-end":"flex-start"},children:o.jsx("div",{style:{maxWidth:"90%",padding:"9px 12px",borderRadius:f.role==="user"?"12px 12px 2px 12px":"12px 12px 12px 2px",background:f.role==="user"?"var(--yt-spec-call-to-action-inverse-color, #cc0000)":"var(--yt-spec-general-background-a, rgba(0,0,0,0.4))",fontSize:13,lineHeight:1.6,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:f.role==="assistant"?f.content?Te(f.content,b):A?o.jsx("span",{style:{color:"var(--yt-spec-text-secondary, #aaa)",fontSize:12,fontStyle:"italic"},children:u?`Searching: "${u}"…`:"▋"}):null:f.content})},j)}),w&&o.jsxs("div",{style:{color:"#f87171",fontSize:12,padding:"4px 0"},children:["Error: ",w]})]}),o.jsxs("div",{style:{padding:"10px 12px",borderTop:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",gap:8,alignItems:"flex-end",flexShrink:0,background:"var(--yt-spec-brand-background-solid, #212121)"},children:[o.jsx("textarea",{value:i,onChange:f=>l(f.target.value),onKeyDown:P,placeholder:"Ask about the video… (Enter to send)",disabled:c||!v||!k||!m,rows:1,style:{flex:1,background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))",borderRadius:20,padding:"9px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,resize:"none",outline:"none",fontFamily:"inherit",lineHeight:1.5,maxHeight:100,overflow:"auto",boxSizing:"border-box"},onFocus:f=>f.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:f=>f.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.15))"}),o.jsx("button",{onClick:z,disabled:c||!i.trim()||!v||!k||!m,style:{background:c||!i.trim()||!v||!k||!m?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))":"var(--yt-spec-call-to-action-inverse-color, #ff0000)",border:"none",borderRadius:"50%",color:"var(--yt-spec-static-brand-white, #fff)",cursor:c||!i.trim()||!v||!k||!m?"default":"pointer",width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:700,transition:"background 0.15s",flexShrink:0,fontFamily:"inherit"},children:c?"…":"↑"})]})]})}function H(n,e){if(!n.trim())return[];const t=n.toLowerCase().trim(),s=[];for(let r=0;r<e.length;r++){const a=e[r];a.text.toLowerCase().includes(t)&&s.push({segment:a,index:r,score:1,matchType:"exact"})}return s}async function oe(n,e,t=8){if(!n.trim())return[];const s=H(n,e),r=new Set(s.map(c=>c.index)),a=await se(n),i=ve(a,e,t),l=[...s];for(const{segment:c,score:p}of i)!r.has(c.index)&&p>.3&&l.push({segment:c,index:c.index,score:p,matchType:"semantic"});return l.sort((c,p)=>c.matchType==="exact"&&p.matchType!=="exact"?-1:p.matchType==="exact"&&c.matchType!=="exact"?1:p.score-c.score),l}function Z(n){return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function ee(n,e){const t=Z(n);if(!e.trim())return t;const s=Z(e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return t.replace(new RegExp(`(${s})`,"gi"),"<mark>$1</mark>")}function $e({segments:n,semanticEnabled:e}){const[t,s]=x.useState(null),[r,a]=x.useState(""),[i,l]=x.useState(null),[c,p]=x.useState(!1),u=x.useRef(null),g=x.useRef(null);x.useEffect(()=>{const d=document.querySelector("video");if(!d)return;function h(){const v=d.currentTime;let k=0;for(let T=0;T<n.length&&n[T].start<=v;T++)k=T;s(k)}return d.addEventListener("timeupdate",h),()=>d.removeEventListener("timeupdate",h)},[n]),x.useEffect(()=>{var h;if(t===null||i!==null)return;const d=(h=u.current)==null?void 0:h.querySelector(`[data-index="${t}"]`);d==null||d.scrollIntoView({block:"nearest",behavior:"smooth"})},[t,i]);function w(d){const h=document.querySelector("video");h&&(h.currentTime=d,h.play())}const S=x.useCallback(async d=>{if(!d.trim()){l(null);return}p(!0);try{const h=e?await oe(d,n):H(d,n).map(v=>({...v}));l(h.map(v=>({segment:v.segment,highlighted:ee(v.segment.text,d),matchType:v.matchType})))}catch{const h=H(d,n).map(v=>({segment:v.segment,highlighted:ee(v.segment.text,d),matchType:v.matchType}));l(h)}finally{p(!1)}},[n,e]);function $(d){const h=d.target.value;if(a(h),g.current&&clearTimeout(g.current),!h.trim()){l(null);return}g.current=setTimeout(()=>S(h),300)}function M(){g.current&&(clearTimeout(g.current),g.current=null);const d=r.trim();if(!d){l(null);return}S(d)}function y(d){d.key==="Enter"&&(d.preventDefault(),M())}const m=i!==null?i:n.map(d=>({segment:d,highlighted:"",matchType:""}));return o.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[o.jsxs("div",{style:{padding:"10px 12px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",flexShrink:0},children:[o.jsxs("div",{style:{display:"flex",gap:"8px",alignItems:"center"},children:[o.jsxs("div",{style:{position:"relative",flex:1},children:[o.jsx("input",{type:"text",value:r,onChange:$,onKeyDown:y,placeholder:e?"Filter by meaning or keyword…":"Filter transcript…",style:{width:"100%",background:"var(--yt-spec-general-background-a, rgba(0,0,0,0.3))",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:"20px",padding:"8px 32px 8px 14px",color:"var(--yt-spec-text-primary, #f1f1f1)",fontSize:13,outline:"none",fontFamily:"inherit",boxSizing:"border-box"},onFocus:d=>d.target.style.borderColor="var(--yt-spec-call-to-action-inverse-color, #ff0000)",onBlur:d=>d.target.style.borderColor="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"}),c?o.jsx("div",{style:{position:"absolute",right:10,top:"50%",transform:"translateY(-50%)",width:14,height:14,border:"2px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.2))",borderTopColor:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",borderRadius:"50%",animation:"yt-transcript-spin 0.6s linear infinite"}}):r?o.jsx("button",{onClick:()=>{a(""),l(null)},style:{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:16,lineHeight:1,padding:0,fontFamily:"inherit"},title:"Clear search",children:"×"}):null]}),o.jsx("button",{type:"button",onClick:M,disabled:c||!r.trim(),style:{flexShrink:0,padding:"8px 14px",borderRadius:"18px",border:"none",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",color:"var(--yt-spec-static-brand-white, #fff)",fontSize:13,fontWeight:600,cursor:c||!r.trim()?"default":"pointer",fontFamily:"inherit",opacity:c||!r.trim()?.6:1},children:"Search"})]}),r&&i!==null&&o.jsxs("p",{style:{margin:"4px 0 0",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i.length===0?"No results":`${i.length} result${i.length===1?"":"s"}`,e&&" · AI semantic search active"]})]}),o.jsxs("div",{ref:u,className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"4px 0"},children:[m.length===0&&r&&o.jsxs("div",{style:{padding:"16px 12px",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:["No results for “",r,"”"]}),m.map(({segment:d,highlighted:h,matchType:v})=>{const k=!r&&t===d.index;return o.jsxs("div",{"data-index":d.index,onClick:()=>w(d.start),style:{padding:"8px 12px",cursor:"pointer",background:k?"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))":"transparent",borderLeft:k?"3px solid var(--yt-spec-call-to-action-inverse-color, #ff0000)":"3px solid transparent",transition:"background 0.15s"},onMouseEnter:T=>{k||(T.currentTarget.style.background="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))")},onMouseLeave:T=>{k||(T.currentTarget.style.background="transparent")},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,marginBottom:2},children:[o.jsx("span",{style:{fontSize:11,fontWeight:700,color:k?"var(--yt-spec-call-to-action-inverse-color, #ff0000)":"var(--yt-spec-text-secondary, #aaa)",fontVariantNumeric:"tabular-nums"},children:G(d.start)}),v==="semantic"&&o.jsx("span",{style:{fontSize:10,background:"rgba(59,130,246,0.15)",color:"#60a5fa",borderRadius:3,padding:"1px 5px",fontWeight:600},children:"AI"})]}),h?o.jsx("p",{style:{margin:0,fontSize:13,color:"var(--yt-spec-text-primary, #f1f1f1)",lineHeight:1.5},dangerouslySetInnerHTML:{__html:h}}):o.jsx("p",{style:{margin:0,fontSize:13,color:k?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-text-secondary, #aaa)",lineHeight:1.5},children:d.text})]},d.index)})]})]})}const _=90,ie=150,Ee=25,O=3;function K(n,e){let t=0;for(let s=0;s<n.length;s++)t+=n[s]*e[s];return t}function Me(n,e){const t=Math.sqrt(K(n,n))*Math.sqrt(K(e,e));return t===0?1:Math.max(-1,Math.min(1,K(n,e)/t))}function te(n){if(!n.length||!n[0].length)return[];const e=n[0].length,t=new Array(e).fill(0);for(const s of n)for(let r=0;r<e;r++)t[r]+=s[r];return t.map(s=>s/n.length)}function ce(n){if(!n.length)return[];const e=[];let t=[],s=n[0].start;for(const r of n)if(t.push(r),r.start-s>=ie){const a=t[t.length-1];e.push({startTime:s,endTime:a.start+(a.duration||0),title:null,segments:t}),t=[],s=r.start+(r.duration||0)}if(t.length){const r=t[t.length-1];e.push({startTime:s,endTime:r.start+(r.duration||0),title:null,segments:t})}return e}function Ce(n){const e=n.length,t=n[e-1].start+(n[e-1].duration||0),s=Math.min(Ee,Math.max(2,Math.round(t/ie)));if(e<O*2+2)return ce(n);const r=[];for(let c=O;c<e-O;c++){const p=te(n.slice(c-O,c).map(g=>g.embedding)),u=te(n.slice(c,c+O).map(g=>g.embedding));r.push({idx:c,score:Me(p,u)})}const a=r.filter((c,p,u)=>{var S,$;const g=((S=u[p-1])==null?void 0:S.score)??1,w=(($=u[p+1])==null?void 0:$.score)??1;return c.score<g&&c.score<w});a.sort((c,p)=>c.score-p.score);const i=[];for(const{idx:c}of a){if(i.length>=s-1)break;const p=n[c].start;if(p<_||t-p<_)continue;i.some(g=>Math.abs(n[g].start-p)<_)||i.push(c)}i.sort((c,p)=>c-p);const l=[0,...i,e];return l.slice(0,-1).map((c,p)=>{const u=l[p+1],g=n.slice(c,u),w=g[g.length-1];return{startTime:g[0].start,endTime:w.start+(w.duration||0),title:null,segments:g}})}function Ae(n){return n.length?n[0].embedding.length>0?{blocks:Ce(n),method:"semantic"}:{blocks:ce(n),method:"time"}:{blocks:[],method:"time"}}function J(n,e){return`yt-transcript-timeline:${n}:${e}`}function Re(n,e){try{const t=localStorage.getItem(J(n,e));return t?JSON.parse(t):null}catch{return null}}function Ie(n,e,t){try{const s={segMethod:e,blockCount:t.length,titles:t.map(r=>r.title??"")};localStorage.setItem(J(n,e),JSON.stringify(s))}catch{}}function Le({segments:n,settings:e,videoId:t}){const[s,r]=x.useState([]),[a,i]=x.useState("time"),[l,c]=x.useState(!1),[p,u]=x.useState(""),g=x.useRef(!1),S=U.filter(m=>!m.requiresKey||(e.apiKeys[m.id]??"").length>0).length>0,$=e.apiKeys[e.selectedProvider]??"";x.useEffect(()=>{if(!n.length)return;const{blocks:m,method:d}=Ae(n);if(i(d),g.current=!1,t){const h=Re(t,d);if(h&&h.blockCount===m.length){const v=m.map((k,T)=>({...k,title:h.titles[T]||null}));r(v),g.current=!0;return}}r(m)},[n,t]),x.useEffect(()=>{s.length>0&&S&&!g.current&&!l&&(g.current=!0,M(s))},[s.length,S]);async function M(m){c(!0),u("");const d=m.map(h=>({startTime:h.startTime,endTime:h.endTime,text:h.segments.map(v=>v.text).join(" ").slice(0,600)}));try{const h=await chrome.runtime.sendMessage({type:"GENERATE_TIMELINE",payload:{blocks:d,provider:e.selectedProvider,model:e.selectedModel,apiKey:$,ollamaBaseUrl:e.ollamaBaseUrl}});if(h!=null&&h.error)u(h.error);else if(h!=null&&h.titles){const v=h.titles,k=m.map((T,C)=>({...T,title:v[C]??`Segment ${C+1}`}));r(k),t&&Ie(t,a,k)}}catch(h){u(h instanceof Error?h.message:"Unknown error")}finally{c(!1)}}function y(m){const d=document.querySelector("video");d&&(d.currentTime=m,d.play())}return n.length?o.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",overflow:"hidden"},children:[o.jsxs("div",{style:{padding:"8px 14px",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",display:"flex",alignItems:"center",gap:8,flexShrink:0},children:[o.jsxs("div",{style:{flex:1},children:[o.jsxs("span",{style:{fontSize:12,color:"var(--yt-spec-text-secondary, #aaa)"},children:[s.length," segments",l&&" · generating titles…"]}),o.jsx("span",{style:{fontSize:10,color:"var(--yt-spec-text-secondary, #666)",marginLeft:6},children:a==="semantic"?"· semantic":"· time-based"}),!S&&o.jsx("span",{style:{fontSize:11,color:"#fbbf24",marginLeft:6},children:"· add an API key to generate titles"})]}),S&&!l&&o.jsx("button",{type:"button",onClick:()=>{if(t)try{localStorage.removeItem(J(t,a))}catch{}g.current=!0,M(s)},style:{background:"transparent",border:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.2))",borderRadius:12,color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:11,padding:"3px 10px",fontFamily:"inherit"},children:"Regenerate"})]}),p&&o.jsxs("div",{style:{padding:"6px 14px",fontSize:11,color:"#f87171",flexShrink:0},children:["Error: ",p]}),o.jsx("div",{className:"yt-transcript-scrollable",style:{flex:1,overflowY:"auto",padding:"8px 0"},children:s.map((m,d)=>{const h=l&&m.title===null,k=((m.endTime-m.startTime)/60).toFixed(1);return o.jsxs("div",{onClick:()=>y(m.startTime),style:{display:"flex",alignItems:"flex-start",padding:"0 14px",cursor:"pointer"},onMouseEnter:T=>{T.currentTarget.style.background="var(--yt-spec-10-percent-layer, rgba(255,255,255,0.04))"},onMouseLeave:T=>{T.currentTarget.style.background="transparent"},children:[o.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",width:20,flexShrink:0,paddingTop:14},children:[o.jsx("div",{style:{width:8,height:8,borderRadius:"50%",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",flexShrink:0}}),d<s.length-1&&o.jsx("div",{style:{width:2,flex:1,minHeight:24,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.12))",margin:"3px 0"}})]}),o.jsxs("div",{style:{flex:1,padding:"8px 0 8px 10px"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"baseline",gap:6,marginBottom:2},children:[o.jsx("span",{style:{fontSize:11,fontWeight:700,color:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",fontVariantNumeric:"tabular-nums"},children:G(m.startTime)}),o.jsxs("span",{style:{fontSize:10,color:"var(--yt-spec-text-secondary, #666)"},children:[k," min"]})]}),h?o.jsx("div",{style:{height:12,width:"60%",borderRadius:6,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.08))",animation:"yt-transcript-pulse 1.2s ease-in-out infinite"}}):o.jsx("span",{style:{fontSize:13,color:m.title?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-text-secondary, #aaa)",lineHeight:1.4},children:m.title??`Segment ${d+1}`})]})]},d)})})]}):o.jsx("div",{style:{padding:24,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13,textAlign:"center"},children:"No transcript loaded."})}function ze({triggerContainer:n,panelContainer:e}){const[t,s]=x.useState(!1),[r,a]=x.useState("transcript"),[i,l]=x.useState("idle"),[c,p]=x.useState(0),[u,g]=x.useState(""),[w,S]=x.useState([]),[$,M]=x.useState([]),[y,m]=x.useState(X),d=x.useRef(X),h=x.useRef(null);x.useEffect(()=>{chrome.runtime.sendMessage({type:"GET_SETTINGS"},b=>{b&&(m(b),d.current=b)})},[t]);function v(b){m(b),d.current=b}x.useEffect(()=>{if(!t||i!=="idle")return;const b=me(window.location.href);if(!b){g("Could not find a video on this page."),l("error");return}h.current=b,k(b)},[t]);async function k(b){try{l("fetching");const{segments:f}=await fe(b),j=ye(f);if(S(j),d.current.semanticSearchEnabled)try{l("embedding");const A=await xe(j,E=>p(E));M(A)}catch(A){console.warn("[YT Transcript] Embedding failed, falling back to exact search:",A)}l("ready")}catch{g("Failed to load transcript."),l("error")}}const T=[{id:"transcript",label:"Transcript"},{id:"chat",label:"AI Chat"},{id:"timeline",label:"Timeline"}],C=$.length>0?$:w.map((b,f)=>({...b,embedding:[],index:f}));x.useEffect(()=>{Se(C)},[C]);const z=o.jsxs("button",{onClick:()=>s(b=>!b),title:t?"Close TranscriptAI":"Open TranscriptAI",style:{display:"inline-flex",alignItems:"center",gap:"6px",background:t?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-badge-chip-background, #272727)",color:t?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",border:"none",borderRadius:"18px",padding:"0 12px",height:"36px",cursor:"pointer",fontFamily:"'Roboto', 'Arial', sans-serif",fontSize:"14px",fontWeight:500,whiteSpace:"nowrap",transition:"background 0.15s, color 0.15s",flexShrink:0},children:[o.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",children:o.jsx("path",{d:"M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"})}),"TranscriptAI"]}),P=t?o.jsxs("div",{className:"yt-transcript-ext",tabIndex:-1,style:{background:"var(--yt-spec-brand-background-solid, #212121)",borderRadius:"12px",overflow:"hidden",marginBottom:"16px",fontFamily:"'Roboto', 'Arial', sans-serif",color:"var(--yt-spec-text-primary, #f1f1f1)"},children:[o.jsxs("div",{style:{padding:"12px 16px 0",borderBottom:"1px solid var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px"},children:[o.jsx("span",{style:{fontWeight:700,fontSize:14,color:"var(--yt-spec-text-primary, #f1f1f1)"},children:"TranscriptAI"}),o.jsxs("span",{style:{marginLeft:"auto",fontSize:11,color:"var(--yt-spec-text-secondary, #aaa)"},children:[i==="ready"&&`${w.length} chunks`,i==="embedding"&&`Embedding… ${c}%`,i==="fetching"&&"Fetching…"]}),o.jsx("button",{onClick:()=>s(!1),title:"Close",style:{marginLeft:8,background:"transparent",border:"none",color:"var(--yt-spec-text-secondary, #aaa)",cursor:"pointer",fontSize:20,lineHeight:1,padding:"0 2px",flexShrink:0,fontFamily:"inherit"},children:"×"})]}),o.jsx("div",{style:{display:"flex",gap:"8px",paddingBottom:"12px",flexWrap:"wrap"},children:T.map(b=>o.jsx("button",{type:"button",onMouseDown:f=>{f.preventDefault(),f.stopPropagation()},onClick:f=>{var j;f.preventDefault(),f.stopPropagation(),(j=document.activeElement)==null||j.blur(),a(b.id)},style:{padding:"0 12px",height:"32px",borderRadius:"16px",border:"none",background:r===b.id?"var(--yt-spec-text-primary, #f1f1f1)":"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.05))",color:r===b.id?"var(--yt-spec-base-background, #0f0f0f)":"var(--yt-spec-text-primary, #f1f1f1)",cursor:"pointer",fontSize:"13px",fontWeight:r===b.id?600:400,fontFamily:"inherit",transition:"background 0.15s, color 0.15s",whiteSpace:"nowrap"},children:b.label},b.id))})]}),o.jsxs("div",{tabIndex:-1,style:{maxHeight:"480px",overflow:"hidden",display:"flex",flexDirection:"column"},children:[i==="error"&&o.jsx("div",{style:{padding:16,color:"#f87171",fontSize:13},children:u}),(i==="fetching"||i==="embedding")&&o.jsxs("div",{style:{padding:24,textAlign:"center",color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:[o.jsx("div",{style:{marginBottom:8},children:i==="fetching"?"Fetching transcript…":`Building search index… ${c}%`}),o.jsx("div",{style:{height:3,background:"var(--yt-spec-10-percent-layer, rgba(255,255,255,0.1))",borderRadius:2,overflow:"hidden"},children:o.jsx("div",{style:{height:"100%",background:"var(--yt-spec-call-to-action-inverse-color, #ff0000)",width:i==="fetching"?"30%":`${c}%`,transition:"width 0.3s"}})})]}),i==="ready"&&o.jsxs(o.Fragment,{children:[r==="transcript"&&o.jsx($e,{segments:C,semanticEnabled:y.semanticSearchEnabled&&$.length>0}),r==="chat"&&o.jsx(je,{segments:w,settings:y,onSettingsChange:v,videoId:h.current}),r==="timeline"&&o.jsx(Le,{segments:C,settings:y,videoId:h.current})]}),i==="idle"&&o.jsx("div",{style:{padding:24,color:"var(--yt-spec-text-secondary, #aaa)",fontSize:13},children:"Opening panel…"})]})]}):null;return o.jsxs(o.Fragment,{children:[Y.createPortal(z,n),Y.createPortal(P??o.jsx(o.Fragment,{}),e)]})}function Ne(){return document.querySelector("#top-level-buttons-computed")??document.querySelector("ytd-watch-metadata #top-level-buttons")??document.querySelector("#actions #top-level-buttons")??document.querySelector("#actions-inner")??null}function Fe(){return document.querySelector("#secondary-inner")??document.querySelector("#secondary")??null}function Pe(){return document.querySelector("#description-inner")??document.querySelector("#description")??null}function De(n){function e(){const s=Ne(),r=Fe(),a=Pe(),i=r??a,l=r?"secondary":"description";return s&&i?(n(s,i,l),!0):!1}if(e())return new MutationObserver(()=>{});const t=new MutationObserver(()=>{e()&&t.disconnect()});return t.observe(document.body,{childList:!0,subtree:!0}),t}let q=null,R=null,I=null,L=null,B=null,F=null;function qe(){q==null||q.unmount(),q=null,R==null||R.remove(),R=null,I==null||I.remove(),I=null,L==null||L.remove(),L=null,B==null||B.disconnect(),B=null,F==null||F.disconnect(),F=null}function Oe(n,e,t){document.getElementById("yt-transcript-app-host")||(I=document.createElement("div"),I.id="yt-transcript-trigger",I.style.cssText="display:inline-flex;align-items:center;margin-right:8px;",n.prepend(I),L=document.createElement("div"),L.id="yt-transcript-panel",t==="secondary"?e.prepend(L):e.insertAdjacentElement("afterend",L),R=document.createElement("div"),R.id="yt-transcript-app-host",R.style.cssText="position:absolute;left:-9999px;top:-9999px;width:0;height:0;overflow:hidden;pointer-events:none;",document.body.appendChild(R),q=le(R),q.render(o.jsx(ze,{triggerContainer:I,panelContainer:L})))}function ne(){B=De(Oe)}function V(){if(document.querySelector("#player")){ne();return}F=new MutationObserver(()=>{document.querySelector("#player")&&(F.disconnect(),F=null,ne())}),F.observe(document.body,{childList:!0,subtree:!0})}chrome.runtime.onMessage.addListener((n,e,t)=>{var c;if(n.type!=="SEARCH_REQUEST")return!1;const s=((c=n.payload)==null?void 0:c.query)??"",r=ke();if(!r.length)return t({results:"No transcript loaded yet."}),!1;function a(p){return p.length?p.map(u=>`[${G(u.segment.start)}] ${u.segment.text}`).join(`
`):"No matching segments found."}if(r.some(p=>p.embedding.length>0))return oe(s,r,15).then(p=>{t({results:a(p)})}).catch(()=>{const p=H(s,r).slice(0,15);t({results:a(p)})}),!0;const l=H(s,r).slice(0,15);return t({results:a(l)}),!1});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",V):V();document.addEventListener("yt-navigate-finish",()=>{qe(),setTimeout(V,500)});
